(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const g=s=>Math.min(Math.max(s,0),1),h=(s,t,e)=>{const n=g(s);return t*Math.pow(e/t,n)},Z=[{id:"bandLimitedPulse",label:"Dirichlet Pulse",description:"Band-limited pulse derived from the Dirichlet kernel with harmonic roll-off.",params:[{id:"harmonics",label:"Harmonics",unit:"count",default:.6,mapValue:s=>Math.max(1,Math.round(1+g(s)*63)),format:s=>`${s}`},{id:"tilt",label:"Tilt",unit:"dB/oct",default:.35,mapValue:s=>-3+g(s)*18,format:s=>`${s.toFixed(1)}`}]},{id:"dsfSingleSided",label:"Single-Sided DSF",description:"Moorer discrete summation formula with variable inharmonic ratio.",params:[{id:"decay",label:"Decay",unit:"a",default:.45,mapValue:s=>g(s)*.98,format:s=>s.toFixed(2)},{id:"ratio",label:"Ratio",unit:"θ/ω",default:.5,mapValue:s=>h(s,.5,4),format:s=>s.toFixed(2)}]},{id:"dsfDoubleSided",label:"Double-Sided DSF",description:"Moorer DSF generating symmetric sidebands above and below the carrier.",params:[{id:"decay",label:"Decay",unit:"a",default:.55,mapValue:s=>g(s)*.96,format:s=>s.toFixed(2)},{id:"ratio",label:"Spread",unit:"θ/ω",default:.6,mapValue:s=>h(s,.5,4.5),format:s=>s.toFixed(2)}]},{id:"tanhSquare",label:"Tanh Square",description:"Hyperbolic tangent waveshaping of a sinusoidal carrier.",params:[{id:"drive",label:"Drive",unit:"index",default:.55,mapValue:s=>h(s,.05,5),format:s=>s.toFixed(2)},{id:"trim",label:"Trim",unit:"gain",default:.5,mapValue:s=>h(s,.2,1.2),format:s=>s.toFixed(2)}]},{id:"tanhSaw",label:"Tanh Saw",description:"Square-to-saw transformation using heterodyned cosine blend.",params:[{id:"drive",label:"Drive",unit:"index",default:.6,mapValue:s=>h(s,.05,4.5),format:s=>s.toFixed(2)},{id:"blend",label:"Blend",unit:"%",default:.4,mapValue:s=>g(s),format:s=>`${Math.round(s*100)}`}]},{id:"paf",label:"Phase-Aligned Formant",description:"PAF oscillator with configurable formant position and bandwidth.",params:[{id:"formant",label:"Formant",unit:"×f0",default:.5,mapValue:s=>h(s,.5,6),format:s=>s.toFixed(2)},{id:"bandwidth",label:"Bandwidth",unit:"Hz",default:.3,mapValue:s=>h(s,50,3e3),format:s=>Math.round(s)}]},{id:"modFm",label:"Modified FM",description:"Modified FM with exponential modulator and smooth spectra.",params:[{id:"index",label:"Index",unit:"k",default:.5,mapValue:s=>h(s,.01,8),format:s=>s.toFixed(2)},{id:"ratio",label:"Ratio",unit:"c:m",default:.4,mapValue:s=>h(s,.25,6),format:s=>s.toFixed(2)}]}],f="tanhSquare";function u(s){return Z.find(t=>t.id===s)??Z[0]}function b(s=f){const t=u(s),e={};return t.params.forEach(n=>{e[n.id]=g(n.default)}),e}function y(s,t,e){const i=u(s).params.find(c=>c.id===t);if(!i)throw new Error(`[AlgorithmRegistry] Unknown param ${t} for ${s}`);const o=g(e),a=i.mapValue(o);return{normalized:o,mapped:a,formatted:i.format(a)}}class x{constructor({onStateChange:t=()=>{},onError:e=n=>console.error("[DisynEngine] Error:",n)}={}){this.audioContext=null,this.node=null,this.currentAlgorithmId=f,this.paramState=b(),this.envelope={attack:.2,release:.4},this.reverb={size:.5,level:.3},this.masterGain=.8,this.onStateChange=t,this.onError=e,this.ready=!1,this.pendingMessages=[]}async initialize(){if(!this.ready)try{const t=new(window.AudioContext||window.webkitAudioContext);this.audioContext=t,await t.audioWorklet.addModule(new URL("data:text/javascript;base64,aW1wb3J0IHsgT3NjaWxsYXRvck1vZHVsZSB9IGZyb20gJy4vbW9kdWxlcy9Pc2NpbGxhdG9yTW9kdWxlLmpzJzsKaW1wb3J0IHsgRW52ZWxvcGVNb2R1bGUgfSBmcm9tICcuL21vZHVsZXMvRW52ZWxvcGVNb2R1bGUuanMnOwppbXBvcnQgeyBSZXZlcmJNb2R1bGUgfSBmcm9tICcuL21vZHVsZXMvUmV2ZXJiTW9kdWxlLmpzJzsKCmNvbnN0IHNhbXBsZVJhdGUgPSBnbG9iYWxUaGlzLnNhbXBsZVJhdGU7CgpjbGFzcyBEaXN5blByb2Nlc3NvciBleHRlbmRzIEF1ZGlvV29ya2xldFByb2Nlc3NvciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigpOwoKICAgIHRoaXMuc2FtcGxlUmF0ZSA9IHNhbXBsZVJhdGU7CiAgICB0aGlzLm9zY2lsbGF0b3IgPSBuZXcgT3NjaWxsYXRvck1vZHVsZSh0aGlzLnNhbXBsZVJhdGUpOwogICAgdGhpcy5lbnZlbG9wZSA9IG5ldyBFbnZlbG9wZU1vZHVsZSh0aGlzLnNhbXBsZVJhdGUpOwogICAgdGhpcy5yZXZlcmIgPSBuZXcgUmV2ZXJiTW9kdWxlKHRoaXMuc2FtcGxlUmF0ZSk7CgogICAgdGhpcy5tYXN0ZXJHYWluID0gMC44OwogICAgdGhpcy5hbGdvcml0aG1JZCA9ICd0YW5oU3F1YXJlJzsKICAgIHRoaXMucGFyYW1zID0ge307CgogICAgdGhpcy52b2ljZSA9IHsKICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgbWlkaTogbnVsbCwKICAgICAgZnJlcXVlbmN5OiA0NDAsCiAgICAgIHZlbG9jaXR5OiAxLAogICAgICBnYXRlOiBmYWxzZSwKICAgIH07CgogICAgdGhpcy5wb3J0Lm9ubWVzc2FnZSA9IChldmVudCkgPT4gdGhpcy5oYW5kbGVNZXNzYWdlKGV2ZW50LmRhdGEpOwogIH0KCiAgaGFuZGxlTWVzc2FnZShtZXNzYWdlKSB7CiAgICBpZiAoIW1lc3NhZ2UgfHwgdHlwZW9mIG1lc3NhZ2UgIT09ICdvYmplY3QnKSByZXR1cm47CgogICAgc3dpdGNoIChtZXNzYWdlLnR5cGUpIHsKICAgICAgY2FzZSAnaW5pdCc6CiAgICAgICAgdGhpcy5hbGdvcml0aG1JZCA9IG1lc3NhZ2UuYWxnb3JpdGhtSWQgPz8gdGhpcy5hbGdvcml0aG1JZDsKICAgICAgICB0aGlzLnBhcmFtcyA9IHRoaXMuZXh0cmFjdFBhcmFtcyhtZXNzYWdlLnBhcmFtcyk7CiAgICAgICAgaWYgKG1lc3NhZ2UuZW52ZWxvcGUpIHsKICAgICAgICAgIHRoaXMuZW52ZWxvcGUuY29uZmlndXJlKG1lc3NhZ2UuZW52ZWxvcGUpOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5yZXZlcmIpIHsKICAgICAgICAgIHRoaXMucmV2ZXJiLnNldFNpemUobWVzc2FnZS5yZXZlcmIuc2l6ZSA/PyAwLjUpOwogICAgICAgICAgdGhpcy5yZXZlcmIuc2V0TGV2ZWwobWVzc2FnZS5yZXZlcmIubGV2ZWwgPz8gMC4zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlLm1hc3RlciA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHRoaXMubWFzdGVyR2FpbiA9IG1lc3NhZ2UubWFzdGVyOwogICAgICAgIH0KICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ2FsZ29yaXRobSc6CiAgICAgICAgdGhpcy5hbGdvcml0aG1JZCA9IG1lc3NhZ2UuaWQgPz8gdGhpcy5hbGdvcml0aG1JZDsKICAgICAgICB0aGlzLnBhcmFtcyA9IHRoaXMuZXh0cmFjdFBhcmFtcyhtZXNzYWdlLnBhcmFtcyk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdwYXJhbSc6CiAgICAgICAgaWYgKCF0aGlzLnBhcmFtcykgdGhpcy5wYXJhbXMgPSB7fTsKICAgICAgICB0aGlzLnBhcmFtc1ttZXNzYWdlLmlkXSA9IG1lc3NhZ2UudmFsdWU7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdlbnZlbG9wZSc6CiAgICAgICAgdGhpcy5lbnZlbG9wZS5jb25maWd1cmUobWVzc2FnZS52YWx1ZSA/PyB7fSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdyZXZlcmInOgogICAgICAgIGlmIChtZXNzYWdlLnZhbHVlKSB7CiAgICAgICAgICB0aGlzLnJldmVyYi5zZXRTaXplKG1lc3NhZ2UudmFsdWUuc2l6ZSA/PyAwLjUpOwogICAgICAgICAgdGhpcy5yZXZlcmIuc2V0TGV2ZWwobWVzc2FnZS52YWx1ZS5sZXZlbCA/PyAwLjMpOwogICAgICAgIH0KICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ21hc3Rlcic6CiAgICAgICAgdGhpcy5tYXN0ZXJHYWluID0gbWVzc2FnZS52YWx1ZSA/PyB0aGlzLm1hc3RlckdhaW47CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdub3RlT24nOgogICAgICAgIHRoaXMudm9pY2UuYWN0aXZlID0gdHJ1ZTsKICAgICAgICB0aGlzLnZvaWNlLm1pZGkgPSBtZXNzYWdlLm1pZGk7CiAgICAgICAgdGhpcy52b2ljZS5mcmVxdWVuY3kgPSBtZXNzYWdlLmZyZXF1ZW5jeSA/PyB0aGlzLnZvaWNlLmZyZXF1ZW5jeTsKICAgICAgICB0aGlzLnZvaWNlLnZlbG9jaXR5ID0gbWVzc2FnZS52ZWxvY2l0eSA/PyAxOwogICAgICAgIHRoaXMudm9pY2UuZ2F0ZSA9IHRydWU7CiAgICAgICAgdGhpcy5lbnZlbG9wZS5nYXRlKHRydWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnbm90ZU9mZic6CiAgICAgICAgaWYgKHRoaXMudm9pY2UubWlkaSA9PT0gbWVzc2FnZS5taWRpKSB7CiAgICAgICAgICB0aGlzLnZvaWNlLmdhdGUgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuZW52ZWxvcGUuZ2F0ZShmYWxzZSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIGV4dHJhY3RQYXJhbXMocmF3KSB7CiAgICBpZiAoIXJhdykgcmV0dXJuIHt9OwogICAgY29uc3QgcmVzdWx0ID0ge307CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhyYXcpKSB7CiAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgZ2VuZXJhdGVTYW1wbGUoKSB7CiAgICBpZiAoIXRoaXMudm9pY2UuYWN0aXZlICYmICF0aGlzLmVudmVsb3BlLmFjdGl2ZSkgewogICAgICByZXR1cm4gMDsKICAgIH0KCiAgICBjb25zdCBlbnYgPSB0aGlzLmVudmVsb3BlLnByb2Nlc3MoKTsKICAgIGlmIChlbnYgPD0gMCAmJiAhdGhpcy52b2ljZS5nYXRlKSB7CiAgICAgIHRoaXMudm9pY2UuYWN0aXZlID0gZmFsc2U7CiAgICAgIHJldHVybiAwOwogICAgfQoKICAgIGNvbnN0IG9zY1NhbXBsZSA9IHRoaXMub3NjaWxsYXRvci5wcm9jZXNzKAogICAgICB0aGlzLmFsZ29yaXRobUlkLAogICAgICB0aGlzLnBhcmFtcywKICAgICAgdGhpcy52b2ljZS5mcmVxdWVuY3kKICAgICk7CgogICAgY29uc3Qgc2FtcGxlID0gb3NjU2FtcGxlICogZW52ICogdGhpcy52b2ljZS52ZWxvY2l0eSAqIHRoaXMubWFzdGVyR2FpbjsKICAgIHJldHVybiB0aGlzLnJldmVyYi5wcm9jZXNzKHNhbXBsZSk7CiAgfQoKICBwcm9jZXNzKF9pbnB1dHMsIG91dHB1dHMpIHsKICAgIGNvbnN0IG91dHB1dCA9IG91dHB1dHNbMF07CiAgICBpZiAoIW91dHB1dCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBjb25zdCBsZWZ0ID0gb3V0cHV0WzBdOwogICAgY29uc3QgcmlnaHQgPSBvdXRwdXRbMV0gPz8gb3V0cHV0WzBdOwoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVmdC5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBzYW1wbGUgPSB0aGlzLmdlbmVyYXRlU2FtcGxlKCk7CiAgICAgIGxlZnRbaV0gPSBzYW1wbGU7CiAgICAgIHJpZ2h0W2ldID0gc2FtcGxlOwogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH0KfQoKcmVnaXN0ZXJQcm9jZXNzb3IoJ2Rpc3luLXByb2Nlc3NvcicsIERpc3luUHJvY2Vzc29yKTsK",import.meta.url));const e=new AudioWorkletNode(t,"disyn-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});e.port.onmessage=n=>this.handleWorkletMessage(n.data),e.onprocessorerror=n=>this.onError(n),e.connect(t.destination),this.node=e,this.ready=!0,this.postStateToWorklet({type:"init",sampleRate:t.sampleRate,algorithmId:this.currentAlgorithmId,params:this.getResolvedParams(),envelope:this.envelope,reverb:this.reverb,master:this.masterGain}),this.flushPendingMessages(),this.notifyState()}catch(t){this.onError(t)}}async ensureRunning(){this.audioContext||await this.initialize(),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),this.notifyState())}suspend(){this.audioContext&&this.audioContext.state!=="closed"&&this.audioContext.suspend().then(()=>this.notifyState())}setMasterGain(t){this.masterGain=Math.min(Math.max(t,0),1),this.postStateToWorklet({type:"master",value:this.masterGain})}setEnvelope({attack:t,release:e}){typeof t=="number"&&(this.envelope.attack=t),typeof e=="number"&&(this.envelope.release=e),this.postStateToWorklet({type:"envelope",value:this.envelope})}setReverb({size:t,level:e}){typeof t=="number"&&(this.reverb.size=t),typeof e=="number"&&(this.reverb.level=e),this.postStateToWorklet({type:"reverb",value:this.reverb})}setAlgorithm(t){const e=u(t);this.currentAlgorithmId=e.id,this.paramState=b(e.id),this.postStateToWorklet({type:"algorithm",id:this.currentAlgorithmId,params:this.getResolvedParams()}),this.notifyState()}setAlgorithmParam(t,e){this.paramState[t]=Math.min(Math.max(e,0),1),this.postStateToWorklet({type:"param",id:t,value:this.getResolvedParam(t)})}noteOn({midi:t,frequency:e,velocity:n=1}){this.ready&&this.postStateToWorklet({type:"noteOn",midi:t,frequency:e,velocity:n,time:this.audioContext.currentTime})}noteOff({midi:t}){this.ready&&this.postStateToWorklet({type:"noteOff",midi:t,time:this.audioContext.currentTime})}handleWorkletMessage(t){t?.type==="log"?console.log("[DisynWorklet]",t.data):t?.type==="error"&&this.onError(new Error(t.message))}postStateToWorklet(t){if(!this.node){this.pendingMessages.push(t);return}this.node.port.postMessage(t)}flushPendingMessages(){!this.node||this.pendingMessages.length===0||(this.pendingMessages.forEach(t=>this.node.port.postMessage(t)),this.pendingMessages.length=0)}getResolvedParams(){const t=u(this.currentAlgorithmId),e={};return t.params.forEach(n=>{const i=this.paramState[n.id]??n.default??0;e[n.id]=y(t.id,n.id,i)}),e}getResolvedParam(t){return y(this.currentAlgorithmId,t,this.paramState[t]??0)}notifyState(){this.onStateChange({contextState:this.audioContext?.state??"pending",algorithmId:this.currentAlgorithmId,params:this.getResolvedParams(),envelope:this.envelope,reverb:this.reverb,masterGain:this.masterGain})}}class N{constructor({element:t,valueElement:e,onInput:n,min:i=0,max:o=100,initial:a=50,bipolar:c=!1,sensitivity:l=.5,resetValue:r=null,formatDisplay:d=null}){if(!t||typeof n!="function")throw new Error("[KnobControl] element and onInput callback are required");this.element=t,this.valueElement=e||null,this.onInput=n,this.min=i,this.max=o,this.value=this._clamp(a),this.bipolar=c,this.sensitivity=l,this.resetValue=r??(i+o)/2,this.formatDisplay=typeof d=="function"?d:null,this._dragging=!1,this._startY=0,this._startValue=this.value,this._bindEvents(),this._render()}_clamp(t){return Math.min(Math.max(t,this.min),this.max)}_normalized(){return this.max===this.min?0:(this.value-this.min)/(this.max-this.min)}_bindEvents(){const t=i=>{this._dragging=!0,this._startY=i,this._startValue=this.value},e=i=>{if(!this._dragging)return;const o=(this._startY-i)*this.sensitivity;this.value=this._clamp(this._startValue+o),this._render(),this.onInput(this._normalized(),this.value)},n=()=>{this._dragging=!1};this.element.addEventListener("mousedown",i=>{i.preventDefault(),t(i.clientY)}),document.addEventListener("mousemove",i=>{e(i.clientY)}),document.addEventListener("mouseup",n),this.element.addEventListener("touchstart",i=>{if(i.touches.length===0)return;const o=i.touches[0];i.preventDefault(),t(o.clientY)},{passive:!1}),document.addEventListener("touchmove",i=>{if(i.touches.length===0)return;const o=i.touches[0];e(o.clientY)},{passive:!1}),document.addEventListener("touchend",n,{passive:!0}),this.element.addEventListener("dblclick",()=>{this.setValue(this.resetValue)})}_render(){const t=this._normalized()*270-135;if(this.element.style.transform=`rotate(${t}deg)`,this.valueElement)if(this.formatDisplay)this.valueElement.textContent=this.formatDisplay(this._normalized(),this.value);else if(this.bipolar){const e=(this.min+this.max)/2,n=Math.round(this.value-e);this.valueElement.textContent=n>=0?`+${n}`:`${n}`}else this.valueElement.textContent=Math.round(this.value)}setValue(t,{emit:e=!0}={}){this.value=this._clamp(t),this._render(),e&&this.onInput(this._normalized(),this.value)}setNormalized(t,{emit:e=!0}={}){const n=Math.min(Math.max(t,0),1),i=this.min+n*(this.max-this.min);this.setValue(i,{emit:e})}}const S=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],K={a:0,w:1,s:2,e:3,d:4,f:5,t:6,g:7,y:8,h:9,u:10,j:11,k:12,o:13,l:14,p:15,";":16,"'":17,"]":18,z:19,x:20,c:21,v:22,b:23,n:24};class m{constructor({container:t,onNoteOn:e,onNoteOff:n,baseMidiNote:i=60,keyMap:o=K,velocity:a=1}){if(!t)throw new Error("[KeyboardInput] container element is required");if(typeof e!="function"||typeof n!="function")throw new Error("[KeyboardInput] onNoteOn and onNoteOff callbacks are required");this.container=t,this.onNoteOn=e,this.onNoteOff=n,this.baseMidiNote=i,this.keyMap=o,this.velocity=a,this.activeNotes=new Set,this.pointerNotes=new Map,this.container.style.touchAction="none",this._bindPointerEvents(),this._bindKeyboardEvents()}static midiToFrequency(t){return 440*Math.pow(2,(t-69)/12)}static midiToName(t){const e=S[t%12],n=Math.floor(t/12)-1;return`${e}${n}`}static nameToMidi(t){const e=/^([A-Ga-g])([#b]?)(-?\d+)$/.exec(t);if(!e)return null;const[,n,i,o]=e,a=parseInt(o,10),c=n.toUpperCase();let l=S.findIndex(r=>r.startsWith(c));return l<0?null:(i==="#"?l=(l+1)%12:i==="b"&&(l=(l+11)%12),l+(a+1)*12)}_bindPointerEvents(){this._onPointerDown=t=>{const e=this._findKeyFromEvent(t);e&&(t.preventDefault(),this._triggerNoteOn(e.midi),this.pointerNotes.set(t.pointerId,e.midi))},this._onPointerMove=t=>{if(!this.pointerNotes.has(t.pointerId))return;const e=this._findKeyFromEvent(t),n=this.pointerNotes.get(t.pointerId);if(!e){n!=null&&this._triggerNoteOff(n),this.pointerNotes.set(t.pointerId,null);return}e.midi!==n&&(n!=null&&this._triggerNoteOff(n),this._triggerNoteOn(e.midi),this.pointerNotes.set(t.pointerId,e.midi))},this._onPointerUp=t=>{const e=this.pointerNotes.get(t.pointerId);e!=null&&this._triggerNoteOff(e),this.pointerNotes.delete(t.pointerId)},this._onPointerCancel=t=>{const e=this.pointerNotes.get(t.pointerId);e!=null&&this._triggerNoteOff(e),this.pointerNotes.delete(t.pointerId)},this._onContextMenu=t=>{t.preventDefault()},this.container.addEventListener("pointerdown",this._onPointerDown),window.addEventListener("pointermove",this._onPointerMove),window.addEventListener("pointerup",this._onPointerUp),window.addEventListener("pointercancel",this._onPointerCancel),this.container.addEventListener("contextmenu",this._onContextMenu)}_bindKeyboardEvents(){this._onKeyDown=t=>{const e=this.keyMap[t.key.toLowerCase()];if(e===void 0)return;t.preventDefault(),t.stopPropagation();const n=this.baseMidiNote+e;this.activeNotes.has(n)||this._triggerNoteOn(n)},this._onKeyUp=t=>{const e=this.keyMap[t.key.toLowerCase()];if(e===void 0)return;t.preventDefault(),t.stopPropagation();const n=this.baseMidiNote+e;this._triggerNoteOff(n)},document.addEventListener("keydown",this._onKeyDown),document.addEventListener("keyup",this._onKeyUp)}_findKeyFromEvent(t){const e=t.target.closest("[data-midi], [data-note]");if(!e||!this.container.contains(e))return null;const n=e.dataset.midi??e.dataset.note,i=this._resolveMidi(n);return i===null?null:{midi:i}}_resolveMidi(t){return t===void 0||t===null?null:typeof t=="number"?t:/^\d+$/.test(t)?parseInt(t,10):m.nameToMidi(t)}_press(t){const e=this._resolveMidi(t);e===null||this.activeNotes.has(e)||this._triggerNoteOn(e)}_release(t){const e=this._resolveMidi(t);e!==null&&this._triggerNoteOff(e)}_triggerNoteOn(t){this.activeNotes.add(t),this._setKeyActiveClass(t,!0);const e={midi:t,name:m.midiToName(t),frequency:m.midiToFrequency(t),velocity:this.velocity};try{this.onNoteOn(e)}catch(n){console.error("[KeyboardInput] onNoteOn callback failure",n)}}_triggerNoteOff(t){if(!this.activeNotes.has(t))return;this.activeNotes.delete(t),this._setKeyActiveClass(t,!1);const e={midi:t,name:m.midiToName(t)};try{this.onNoteOff(e)}catch(n){console.error("[KeyboardInput] onNoteOff callback failure",n)}}_setKeyActiveClass(t,e){const n=m.midiToName(t),i=`[data-midi="${t}"], [data-note="${n}"]`,o=this.container.querySelector(i);o&&o.classList.toggle("active",e)}releaseAll(){[...this.activeNotes].forEach(t=>this._triggerNoteOff(t)),this.pointerNotes.clear()}destroy(){this.releaseAll(),this._onPointerDown&&(this.container.removeEventListener("pointerdown",this._onPointerDown),window.removeEventListener("pointermove",this._onPointerMove),window.removeEventListener("pointerup",this._onPointerUp),window.removeEventListener("pointercancel",this._onPointerCancel),this.container.removeEventListener("contextmenu",this._onContextMenu)),this._onKeyDown&&(document.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("keyup",this._onKeyUp))}}class I{constructor({onNoteOn:t,onNoteOff:e,onControlChange:n=null,onActivity:i=null}={}){this.onNoteOn=typeof t=="function"?t:null,this.onNoteOff=typeof e=="function"?e:null,this.onControlChange=typeof n=="function"?n:null,this.onActivity=typeof i=="function"?i:null,this.midiAccess=null,this.selectedInput=null,this.selectedChannel="all",this.enabled=!0,this.activeNotes=new Map,this.onDeviceChange=null}async initialize(){if(!navigator.requestMIDIAccess)return console.warn("[MidiInputManager] Web MIDI API not available"),!1;try{this.midiAccess=await navigator.requestMIDIAccess(),this.midiAccess.onstatechange=e=>{typeof this.onDeviceChange=="function"&&this.onDeviceChange(this.listInputs()),e.port===this.selectedInput&&e.port.state!=="connected"&&this._disconnectCurrentInput()};const t=this.listInputs();return t.length>0&&this.selectInput(t[0].id),!0}catch(t){return console.error("[MidiInputManager] Failed to initialize",t),!1}}listInputs(){if(!this.midiAccess)return[];const t=[];for(const e of this.midiAccess.inputs.values())t.push({id:e.id,name:e.name||"Unknown Device",manufacturer:e.manufacturer||"",state:e.state});return t}selectInput(t){if(this._disconnectCurrentInput(),!t||!this.midiAccess){this.selectedInput=null;return}const e=this.midiAccess.inputs.get(t);if(!e){console.warn(`[MidiInputManager] Input ${t} not found`);return}this.selectedInput=e,this.selectedInput.onmidimessage=n=>this._handleMessage(n)}_disconnectCurrentInput(){this.selectedInput&&(this.selectedInput.onmidimessage=null)}setChannel(t){if(t==="all"){this.selectedChannel="all";return}const e=parseInt(t,10);Number.isInteger(e)&&e>=1&&e<=16&&(this.selectedChannel=e)}setEnabled(t){this.enabled=!!t,this.enabled||this._releaseAllNotes()}shutdown(){this._releaseAllNotes(),this._disconnectCurrentInput(),this.selectedInput=null}_handleMessage(t){if(!this.enabled)return;const[e,n,i]=t.data,o=e&240,a=(e&15)+1;if(!(this.selectedChannel!=="all"&&a!==this.selectedChannel))switch(this.onActivity&&this.onActivity({messageType:o,channel:a}),o){case 144:i>0?this._handleNoteOn(n,i,a):this._handleNoteOff(n,a);break;case 128:this._handleNoteOff(n,a);break;case 176:this.onControlChange&&this.onControlChange({controller:n,value:i,channel:a});break}}_handleNoteOn(t,e,n){const i=performance.now();if(this.activeNotes.set(t,{velocity:e,channel:n,timestamp:i}),this.onNoteOn){const o={midi:t,velocity:e/127,channel:n,name:I.midiToName(t),frequency:I.midiToFrequency(t)};try{this.onNoteOn(o)}catch(a){console.error("[MidiInputManager] onNoteOn callback failed",a)}}}_handleNoteOff(t,e){if(this.activeNotes.get(t)&&(this.activeNotes.delete(t),this.onNoteOff)){const i={midi:t,channel:e,name:I.midiToName(t)};try{this.onNoteOff(i)}catch(o){console.error("[MidiInputManager] onNoteOff callback failed",o)}}}_releaseAllNotes(){for(const t of this.activeNotes.keys())this._handleNoteOff(t,this.activeNotes.get(t)?.channel??"all");this.activeNotes.clear()}static midiToFrequency(t){return 440*Math.pow(2,(t-69)/12)}static midiToName(t){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=t%12,i=Math.floor(t/12)-1;return`${e[n]}${i}`}}const M=s=>s<.01?`${Math.round(s*1e3)}ms`:s<1?`${(s*1e3).toFixed(0)}ms`:`${s.toFixed(2)}s`,L=s=>.001*Math.pow(1/.001,s),E=s=>.01*Math.pow(3/.01,s),z="(min-width: 900px)",G=["a","w","s","e","d","f","t","g","y","h","u","j","k","o","l","p",";","'","]","z","x","c","v","b","n"],X=[{name:"C",isBlack:!1},{name:"C#",isBlack:!0},{name:"D",isBlack:!1},{name:"D#",isBlack:!0},{name:"E",isBlack:!1},{name:"F",isBlack:!1},{name:"F#",isBlack:!0},{name:"G",isBlack:!1},{name:"G#",isBlack:!0},{name:"A",isBlack:!1},{name:"A#",isBlack:!0},{name:"B",isBlack:!1}],F=18;class V{constructor(t){this.container=t,this.engineState=null,this.engine=new x({onStateChange:e=>this.handleEngineState(e),onError:e=>this.showError(e)}),this.midi=new I({onNoteOn:e=>this.handleNoteOn(e),onNoteOff:e=>this.handleNoteOff(e),onActivity:()=>this.flashMidiActivity()}),this.algorithmKnobs=new Map,this.envelopeKnobs=new Map,this.reverbKnobs=new Map,this.keyboardMedia=window.matchMedia(z),this.currentOctaves=this.keyboardMedia.matches?2:1,this.handleMediaChange=e=>{const n=e.matches?2:1;this.updateKeyboardLayout(n)},this.handleResize=()=>{this.updateKeyboardLayout(this.currentOctaves)}}mount(){this.render(),this.setupAlgorithmControls(),this.setupEnvelopeControls(),this.setupReverbControls(),this.setupKeyboard(),this.setupPowerButton(),this.setupMidiControls(),this.keyboardMedia.addEventListener("change",this.handleMediaChange),window.addEventListener("resize",this.handleResize),this.updateAlgorithmParams(f,b()),this.updateStatusPill("pending")}render(){this.container.innerHTML=`
      <div class="app">
        <header class="app__header">
          <h1 class="app__title">Disyn Distortion Synth</h1>
          <div class="app__status">
            <span class="status-pill status-pill--off" data-status-pill>Power Off</span>
            <button class="power-button" data-power>Power</button>
          </div>
        </header>

        <section class="panel algorithm-panel">
          <h2 class="panel__title">Oscillator Algorithms</h2>
          <div class="algorithm-select">
            <div class="algorithm-select__control">
              <label for="algorithm-select">Algorithm</label>
              <select id="algorithm-select" data-algorithm-select>
                ${Z.map(t=>`<option value="${t.id}">${t.label}</option>`).join("")}
              </select>
            </div>
            <p class="algorithm-select__description" data-algorithm-description></p>
          </div>
          <div class="controls-grid" data-algorithm-controls></div>
        </section>

        <section class="panel">
          <h2 class="panel__title">Envelope & Reverb</h2>
          <div class="controls-grid">
            <div data-envelope-controls class="controls-grid"></div>
            <div data-reverb-controls class="controls-grid"></div>
          </div>
        </section>

        <section class="panel">
          <h2 class="panel__title">Keyboard & MIDI</h2>
          <div class="keyboard">
            <div class="keyboard__keys" data-keyboard-keys></div>
            <div class="keyboard__legend" data-keyboard-legend></div>
          </div>
          <div class="midi-status">
            <span class="status-pill status-pill--off" data-midi-pill>MIDI Offline</span>
            <div class="midi-status__devices">
              <label for="midi-devices">Device</label>
              <select id="midi-devices" data-midi-select disabled>
                <option>No Devices</option>
              </select>
            </div>
            <label>
              <input type="checkbox" class="toggle" data-midi-toggle checked />
            </label>
            <div class="midi-activity" data-midi-activity></div>
          </div>
        </section>
      </div>
    `}setupPowerButton(){this.container.querySelector("[data-power]").addEventListener("click",async()=>{try{!this.engine.audioContext||this.engine.audioContext.state==="suspended"?await this.engine.ensureRunning():this.engine.suspend()}catch(e){this.showError(e)}})}setupAlgorithmControls(){this.algorithmSelect=this.container.querySelector("[data-algorithm-select]"),this.algorithmDescription=this.container.querySelector("[data-algorithm-description]"),this.algorithmControlsContainer=this.container.querySelector("[data-algorithm-controls]"),this.algorithmSelect.addEventListener("change",e=>{const n=e.target.value,i=u(n);this.algorithmDescription.textContent=i.description,this.buildAlgorithmKnobs(n),this.engine.setAlgorithm(n)});const t=u(f);this.algorithmDescription.textContent=t.description,this.buildAlgorithmKnobs(f)}buildAlgorithmKnobs(t){this.algorithmControlsContainer.innerHTML="",this.algorithmKnobs.clear();const e=u(t),n=b(t);e.params.forEach(i=>{const o=document.createElement("div");o.className="knob",o.innerHTML=`
        <div class="knob__ring"></div>
        <div class="knob__label">${i.label}</div>
        <div class="knob__value" data-value>-</div>
      `,this.algorithmControlsContainer.appendChild(o);const a=o.querySelector(".knob__ring"),c=o.querySelector("[data-value]"),l=n[i.id]??i.default??.5,r=y(t,i.id,l);c.textContent=r.formatted;const d=new N({element:a,valueElement:c,initial:l*100,onInput:C=>{this.engine.setAlgorithmParam(i.id,C)},formatDisplay:C=>y(t,i.id,C).formatted});this.algorithmKnobs.set(i.id,{control:d,valueElement:c})})}setupEnvelopeControls(){const t=this.container.querySelector("[data-envelope-controls]");t.innerHTML="";const e=this.createKnob({label:"Attack",initial:.2,format:i=>M(L(i)),onChange:i=>{this.engine.setEnvelope({attack:i})}}),n=this.createKnob({label:"Release",initial:.4,format:i=>M(E(i)),onChange:i=>{this.engine.setEnvelope({release:i})}});t.appendChild(e.element),t.appendChild(n.element),this.envelopeKnobs.set("attack",e.control),this.envelopeKnobs.set("release",n.control)}setupReverbControls(){const t=this.container.querySelector("[data-reverb-controls]");t.innerHTML="";const e=this.createKnob({label:"Room Size",initial:.5,format:i=>`${Math.round(i*100)}%`,onChange:i=>{this.engine.setReverb({size:i})}}),n=this.createKnob({label:"Wet Level",initial:.3,format:i=>`${Math.round(i*100)}%`,onChange:i=>{this.engine.setReverb({level:i})}});t.appendChild(e.element),t.appendChild(n.element),this.reverbKnobs.set("size",e.control),this.reverbKnobs.set("level",n.control)}createKnob({label:t,initial:e=.5,format:n,onChange:i}){const o=document.createElement("div");o.className="knob",o.innerHTML=`
      <div class="knob__ring"></div>
      <div class="knob__label">${t}</div>
      <div class="knob__value">${n(e)}</div>
    `;const a=o.querySelector(".knob__ring"),c=o.querySelector(".knob__value"),l=new N({element:a,valueElement:c,initial:e*100,onInput:r=>{c.textContent=n(r),i(r)},formatDisplay:n});return{element:o,control:l}}setupKeyboard(){this.keysContainer=this.container.querySelector("[data-keyboard-keys]"),this.keyboardLegend=this.container.querySelector("[data-keyboard-legend]"),this.updateKeyboardLayout(this.currentOctaves)}updateKeyboardLayout(t){if(this.currentOctaves=t,!this.keysContainer)return;const e=this.generateKeyLayout(t);this.renderKeyboardLayers(e),this.updateKeyboardLegend(t),this.initializeKeyboardInput(t)}initializeKeyboardInput(t){this.keyboard&&typeof this.keyboard.destroy=="function"&&this.keyboard.destroy(),this.keyboard=new m({container:this.keysContainer,baseMidiNote:60,keyMap:this.getKeyMapForOctaves(t),onNoteOn:e=>this.handleNoteOn(e),onNoteOff:e=>this.handleNoteOff(e)})}generateKeyLayout(t){const e=[],n=[];let i=60,o=4,a=0;for(let l=0;l<t;l++)X.forEach(r=>{const d=`${r.name}${o}`;r.isBlack?n.push({midi:i,name:d,precedingWhiteIndex:Math.max(a-1,0)}):(e.push({midi:i,name:d,label:d}),a+=1),i+=1,!r.isBlack&&r.name==="B"&&(o+=1)});const c=`C${o}`;return e.push({midi:i,name:c,label:c}),{whiteKeys:e,blackKeys:n}}renderKeyboardLayers({whiteKeys:t,blackKeys:e}){this.keysContainer.innerHTML="";const n=document.createElement("div");n.className="keyboard__white-keys";const i=t.map(r=>{const d=document.createElement("div");return d.className="key white",d.dataset.midi=r.midi,d.dataset.note=r.name,d.innerHTML=`<span class="key__label">${r.label}</span>`,n.appendChild(d),d});this.keysContainer.appendChild(n);const o=i.map(r=>r.getBoundingClientRect()),a=this.keysContainer.getBoundingClientRect(),c=parseFloat(getComputedStyle(this.keysContainer).paddingLeft)||F,l=document.createElement("div");l.className="keyboard__black-keys",e.forEach(r=>{const d=r.precedingWhiteIndex,C=d+1,A=o[d],v=o[C];if(!A||!v)return;const p=document.createElement("div");p.className="key black",p.dataset.midi=r.midi,p.dataset.note=r.name;const W=(A.right+v.left)/2,_=Math.min(A.width,v.width),w=Math.max(_*.6,20),B=W-w/2-a.left-c;p.style.width=`${w}px`,p.style.left=`${B}px`,l.appendChild(p)}),this.keysContainer.appendChild(l)}updateKeyboardLegend(t){if(!this.keyboardLegend)return;const e=t*12+1,n=G.slice(0,e).map(i=>i.toUpperCase());if(t===1)this.keyboardLegend.textContent=n.join(" ");else{const i=Math.ceil(n.length/2),o=n.slice(0,i).join(" "),a=n.slice(i).join(" ");this.keyboardLegend.innerHTML=`${o}<br>${a}`}}getKeyMapForOctaves(t){const e=t*12+1,n={};return G.slice(0,e).forEach((i,o)=>{n[i]=o}),n}async handleNoteOn(t){try{await this.engine.ensureRunning(),this.engine.noteOn(t)}catch(e){this.showError(e)}}handleNoteOff(t){this.engine.noteOff(t)}setupMidiControls(){const t=this.container.querySelector("[data-midi-toggle]"),e=this.container.querySelector("[data-midi-select]"),n=this.container.querySelector("[data-midi-pill]");t.addEventListener("change",i=>{const o=i.target.checked;this.midi.setEnabled(o),this.updateMidiStatus(o)}),e.addEventListener("change",i=>{const o=i.target.value;this.midi.selectInput(o)}),this.midi.onDeviceChange=i=>{if(e.innerHTML="",i.length===0){e.innerHTML="<option>No Devices</option>",e.disabled=!0;return}i.forEach(o=>{const a=document.createElement("option");a.value=o.id,a.textContent=`${o.name}`,e.appendChild(a)}),e.disabled=!1},this.initMidi().then(i=>{n.textContent=i?"MIDI Ready":"MIDI Unavailable",n.classList.toggle("status-pill--off",!i),this.updateMidiStatus(i&&t.checked)})}async initMidi(){return await this.midi.initialize()}updateMidiStatus(t){const e=this.container.querySelector("[data-midi-pill]");e&&(t?(e.textContent="MIDI Active",e.classList.remove("status-pill--off")):(e.textContent="MIDI Muted",e.classList.add("status-pill--off")))}flashMidiActivity(){const t=this.container.querySelector("[data-midi-activity]");t&&(t.classList.add("midi-activity--on"),clearTimeout(this.midiActivityTimeout),this.midiActivityTimeout=setTimeout(()=>{t.classList.remove("midi-activity--on")},150))}handleEngineState(t){this.engineState=t,this.updateStatusPill(t.contextState),this.updateAlgorithmState(t)}updateStatusPill(t){const e=this.container.querySelector("[data-status-pill]");if(!e)return;let n="Power Off",i=!1;switch(t){case"running":n="Audio Running",i=!1;break;case"suspended":n="Suspended",i=!0;break;case"closed":n="Closed",i=!0;break;default:n="Ready",i=!0}e.textContent=n,e.classList.toggle("status-pill--off",i)}updateAlgorithmState(t){if(!t?.params)return;u(t.algorithmId).params.forEach(n=>{const i=this.algorithmKnobs.get(n.id);if(!i)return;const o=t.params[n.id];if(!o)return;const a=o.normalized;i.control.setNormalized(a,{emit:!1})})}updateAlgorithmParams(t,e){u(t).params.forEach(i=>{const o=this.algorithmKnobs.get(i.id);if(!o)return;const a=e[i.id]??i.default??.5;o.control.setNormalized(a,{emit:!1})})}showError(t){console.error("[Disyn] Error",t),window.dispatchEvent(new CustomEvent("disyn:error",{detail:t}))}}const k=()=>{const s=document.getElementById("app");if(!s)throw new Error("[Disyn] #app container missing");new V(s).mount()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",k):k();
//# sourceMappingURL=index-DNcml30B.js.map
