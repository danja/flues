(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class v{constructor(e=44100){this.sampleRate=e,this.delayLine=null,this.delayLength=100,this.readPos=0,this.writePos=0,this.breathPressure=.7,this.reedStiffness=.5,this.noiseLevel=.15,this.lpf={x1:0,y1:0,cutoff:.7},this.hpf={x1:0,y1:0,cutoff:.01},this.envelope=0,this.attackTime=.01,this.releaseTime=.05,this.gate=!1,this.vibratoAmount=0,this.vibratoRate=5,this.vibratoPhase=0,this.frequency=440,this.targetFrequency=440,this.isPlaying=!1}setFrequency(e){this.targetFrequency=e;const t=Math.floor(this.sampleRate/e);(!this.delayLine||t!==this.delayLength)&&(this.delayLength=t,this.delayLine=new Float32Array(this.delayLength),this.delayLine.fill(0),this.readPos=0,this.writePos=0)}reedReflection(e){const t=this.reedStiffness*5+.5,s=e*t;if(s>3)return 1;if(s<-3)return-1;const i=s*s;return s*(27+i)/(27+9*i)}lowpass(e,t){const s=t;return this.lpf.y1=s*e+(1-s)*this.lpf.y1,this.lpf.y1}highpass(e,t){const i=t*(this.hpf.y1+e-this.hpf.x1);return this.hpf.x1=e,this.hpf.y1=i,i}saturate(e){if(e>3)return 1;if(e<-3)return-1;const t=e*e;return e*(27+t)/(27+9*t)}generateNoise(){return(Math.random()*2-1)*this.noiseLevel}updateEnvelope(e){if(this.gate){const t=1/(this.attackTime*this.sampleRate);this.envelope+=t*e,this.envelope>1&&(this.envelope=1)}else{const t=1/(this.releaseTime*this.sampleRate);this.envelope-=t*e,this.envelope<0&&(this.envelope=0,this.isPlaying=!1)}return this.envelope}process(){if(!this.delayLine||this.delayLength===0)return 0;const e=this.updateEnvelope(1);if(e<=.001)return 0;this.vibratoPhase+=this.vibratoRate*2*Math.PI/this.sampleRate,this.vibratoPhase>2*Math.PI&&(this.vibratoPhase-=2*Math.PI);const t=Math.sin(this.vibratoPhase)*this.vibratoAmount,i=this.sampleRate/this.targetFrequency*(1+t),n=Math.min(i,this.delayLength-1),c=(this.writePos-n+this.delayLength)%this.delayLength,l=Math.floor(c),d=c-l,f=(l+1)%this.delayLength,u=this.delayLine[l]*(1-d)+this.delayLine[f]*d,m=this.generateNoise(),y=this.breathPressure*e+m*e-u,g=this.reedReflection(y);let r=u+g*.5;return r=this.lowpass(r,this.lpf.cutoff),r=this.highpass(r,this.hpf.cutoff),r=this.saturate(r*.95),this.delayLine[this.writePos]=r,this.writePos=(this.writePos+1)%this.delayLength,r*e*.5}noteOn(e){if(this.setFrequency(e),this.gate=!0,this.isPlaying=!0,this.vibratoPhase=0,this.delayLine)for(let t=0;t<this.delayLength;t++)this.delayLine[t]=(Math.random()*2-1)*.01}noteOff(){this.gate=!1}setBreath(e){this.breathPressure=e*.8+.2}setReedStiffness(e){this.reedStiffness=e}setNoise(e){this.noiseLevel=e*.3}setAttack(e){this.attackTime=e*.1+.001}setRelease(e){this.releaseTime=e*.3+.01}setDamping(e){this.lpf.cutoff=.3+e*.69}setBrightness(e){this.hpf.cutoff=e*.05}setVibrato(e){this.vibratoAmount=e*.01}}class b{constructor(){this.audioContext=null,this.scriptNode=null,this.engine=null,this.analyser=null,this.isActive=!1}async initialize(){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.engine=new v(this.audioContext.sampleRate),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.connect(this.audioContext.destination),this.scriptNode=this.audioContext.createScriptProcessor(4096,0,1),this.scriptNode.onaudioprocess=e=>{const t=e.outputBuffer.getChannelData(0);for(let s=0;s<t.length;s++)t[s]=this.engine.process()},this.scriptNode.connect(this.analyser),this.isActive=!0}noteOn(e){this.audioContext.state==="suspended"&&this.audioContext.resume(),this.engine.noteOn(e)}noteOff(){this.engine.noteOff()}setParameter(e,t){switch(e){case"breath":this.engine.setBreath(t);break;case"reed":this.engine.setReedStiffness(t);break;case"noise":this.engine.setNoise(t);break;case"attack":this.engine.setAttack(t);break;case"release":this.engine.setRelease(t);break;case"damping":this.engine.setDamping(t);break;case"brightness":this.engine.setBrightness(t);break;case"vibrato":this.engine.setVibrato(t);break}}getAnalyserData(){if(!this.analyser)return null;const e=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteTimeDomainData(e),e}shutdown(){this.scriptNode&&this.scriptNode.disconnect(),this.audioContext&&this.audioContext.close(),this.isActive=!1}}class o{constructor(e,t,s,i=0,n=100,a=50){this.element=e,this.valueElement=t,this.onChange=s,this.min=i,this.max=n,this.value=a,this.isDragging=!1,this.startY=0,this.startValue=0,this.setupListeners(),this.updateDisplay()}setupListeners(){this.element.addEventListener("mousedown",e=>{this.isDragging=!0,this.startY=e.clientY,this.startValue=this.value,e.preventDefault()}),document.addEventListener("mousemove",e=>{if(this.isDragging){const t=(this.startY-e.clientY)*.5;this.value=Math.max(this.min,Math.min(this.max,this.startValue+t)),this.updateDisplay(),this.onChange(this.value/100)}}),document.addEventListener("mouseup",()=>{this.isDragging=!1}),this.element.addEventListener("touchstart",e=>{this.isDragging=!0,this.startY=e.touches[0].clientY,this.startValue=this.value,e.preventDefault()}),document.addEventListener("touchmove",e=>{if(this.isDragging){const t=(this.startY-e.touches[0].clientY)*.5;this.value=Math.max(this.min,Math.min(this.max,this.startValue+t)),this.updateDisplay(),this.onChange(this.value/100)}}),document.addEventListener("touchend",()=>{this.isDragging=!1}),this.element.addEventListener("dblclick",()=>{this.value=(this.min+this.max)/2,this.updateDisplay(),this.onChange(this.value/100)})}updateDisplay(){const e=this.value/100*270-135;this.element.style.transform=`rotate(${e}deg)`,this.valueElement.textContent=Math.round(this.value)}setValue(e){this.value=Math.max(this.min,Math.min(this.max,e)),this.updateDisplay()}}class w{constructor(e,t,s){this.container=e,this.onNoteOn=t,this.onNoteOff=s,this.activeKeys=new Set,this.keyMap=this.createKeyMap(),this.setupListeners()}createKeyMap(){return{a:"C4",w:"C#4",s:"D4",e:"D#4",d:"E4",f:"F4",t:"F#4",g:"G4",y:"G#4",h:"A4",u:"A#4",j:"B4",k:"C5"}}noteToFrequency(e){return{C4:261.63,"C#4":277.18,D4:293.66,"D#4":311.13,E4:329.63,F4:349.23,"F#4":369.99,G4:392,"G#4":415.3,A4:440,"A#4":466.16,B4:493.88,C5:523.25}[e]||440}setupListeners(){this.container.querySelectorAll(".key").forEach(t=>{const s=t.dataset.note;t.addEventListener("mousedown",i=>{i.preventDefault(),this.pressKey(s)}),t.addEventListener("mouseup",()=>{this.releaseKey(s)}),t.addEventListener("mouseleave",()=>{this.activeKeys.has(s)&&this.releaseKey(s)}),t.addEventListener("touchstart",i=>{i.preventDefault(),this.pressKey(s)}),t.addEventListener("touchend",i=>{i.preventDefault(),this.releaseKey(s)})}),document.addEventListener("keydown",t=>{const s=this.keyMap[t.key.toLowerCase()];s&&!this.activeKeys.has(s)&&this.pressKey(s)}),document.addEventListener("keyup",t=>{const s=this.keyMap[t.key.toLowerCase()];s&&this.releaseKey(s)})}pressKey(e){if(this.activeKeys.has(e))return;this.activeKeys.add(e);const t=this.container.querySelector(`[data-note="${e}"]`);t&&t.classList.add("active");const s=this.noteToFrequency(e);this.onNoteOn(e,s)}releaseKey(e){if(!this.activeKeys.has(e))return;this.activeKeys.delete(e);const t=this.container.querySelector(`[data-note="${e}"]`);t&&t.classList.remove("active"),this.onNoteOff(e)}releaseAllKeys(){this.activeKeys.forEach(e=>{this.releaseKey(e)})}}class P{constructor(e){this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.isRunning=!1,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const e=this.canvas.getBoundingClientRect();this.canvas.width=e.width,this.canvas.height=e.height}start(e){this.isRunning=!0,this.dataFunction=e,this.draw()}stop(){this.isRunning=!1}draw(){if(!this.isRunning)return;const e=this.dataFunction();if(this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),e){this.ctx.lineWidth=2,this.ctx.strokeStyle="#4a9eff",this.ctx.beginPath();const t=this.canvas.width/e.length;let s=0;for(let i=0;i<e.length;i++){const a=e[i]/128*this.canvas.height/2;i===0?this.ctx.moveTo(s,a):this.ctx.lineTo(s,a),s+=t}this.ctx.stroke()}requestAnimationFrame(()=>this.draw())}}class p{constructor(){this.processor=null,this.keyboard=null,this.visualizer=null,this.knobs={},this.isActive=!1,this.currentNote=null,this.initializeUI()}initializeUI(){document.getElementById("power-button").addEventListener("click",()=>this.togglePower()),this.knobs.breath=new o(document.getElementById("breath-knob"),document.getElementById("breath-value"),t=>this.updateParameter("breath",t),0,100,70),this.knobs.reed=new o(document.getElementById("reed-knob"),document.getElementById("reed-value"),t=>this.updateParameter("reed",t),0,100,50),this.knobs.noise=new o(document.getElementById("noise-knob"),document.getElementById("noise-value"),t=>this.updateParameter("noise",t),0,100,15),this.knobs.attack=new o(document.getElementById("attack-knob"),document.getElementById("attack-value"),t=>this.updateParameter("attack",t),0,100,10),this.knobs.damping=new o(document.getElementById("damping-knob"),document.getElementById("damping-value"),t=>this.updateParameter("damping",t),0,100,20),this.knobs.brightness=new o(document.getElementById("brightness-knob"),document.getElementById("brightness-value"),t=>this.updateParameter("brightness",t),0,100,70),this.knobs.vibrato=new o(document.getElementById("vibrato-knob"),document.getElementById("vibrato-value"),t=>this.updateParameter("vibrato",t),0,100,0),this.knobs.release=new o(document.getElementById("release-knob"),document.getElementById("release-value"),t=>this.updateParameter("release",t),0,100,50),this.keyboard=new w(document.getElementById("keyboard"),(t,s)=>this.handleNoteOn(t,s),t=>this.handleNoteOff(t)),this.visualizer=new P(document.getElementById("visualizer")),this.updateStatus()}async togglePower(){this.isActive?this.powerOff():await this.powerOn()}async powerOn(){try{this.processor=new b,await this.processor.initialize(),this.updateParameter("breath",this.knobs.breath.value/100),this.updateParameter("reed",this.knobs.reed.value/100),this.updateParameter("noise",this.knobs.noise.value/100),this.updateParameter("attack",this.knobs.attack.value/100),this.updateParameter("damping",this.knobs.damping.value/100),this.updateParameter("brightness",this.knobs.brightness.value/100),this.updateParameter("vibrato",this.knobs.vibrato.value/100),this.updateParameter("release",this.knobs.release.value/100),this.visualizer.start(()=>this.processor.getAnalyserData()),this.isActive=!0,document.getElementById("power-button").classList.add("active"),this.updateStatus(),console.log("Clarinet synthesizer powered on")}catch(e){console.error("Failed to initialize audio:",e),alert("Failed to initialize audio. Please check browser compatibility.")}}powerOff(){this.processor&&(this.keyboard.releaseAllKeys(),this.processor.shutdown(),this.processor=null),this.visualizer.stop(),this.isActive=!1,this.currentNote=null,document.getElementById("power-button").classList.remove("active"),this.updateStatus(),console.log("Clarinet synthesizer powered off")}handleNoteOn(e,t){this.isActive&&(this.currentNote=e,this.processor.noteOn(t),this.updateStatus())}handleNoteOff(e){this.isActive&&this.currentNote===e&&(this.processor.noteOff(),this.currentNote=null,this.updateStatus())}updateParameter(e,t){this.processor&&this.processor.isActive&&this.processor.setParameter(e,t)}updateStatus(){const e=document.getElementById("status"),t=document.getElementById("current-note");e.textContent=this.isActive?"ON":"OFF",e.style.color=this.isActive?"#4eff4a":"#ff4a4a",t.textContent=this.currentNote||"---",this.isActive?this.updateCPU():document.getElementById("cpu").textContent="0%"}updateCPU(){const e=this.processor&&this.processor.engine&&this.processor.engine.isPlaying?Math.floor(15+Math.random()*10):Math.floor(5+Math.random()*5);document.getElementById("cpu").textContent=e+"%",this.isActive&&setTimeout(()=>this.updateCPU(),100)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.synthApp=new p}):window.synthApp=new p;window.addEventListener("beforeunload",()=>{window.synthApp&&window.synthApp.isActive&&window.synthApp.powerOff()});
