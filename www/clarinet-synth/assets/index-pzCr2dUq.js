(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const b=.7,k=.5,P=.15,L=.7,A=.01,N=.01,x=.05,O=0,S=5,g=440,I=100,T=5,D=.5,l=3,c=27,m=9,F=.95,B=.5,R=.01;class _{constructor(e=44100){this.sampleRate=e,this.delayLine=null,this.delayLength=I,this.readPos=0,this.writePos=0,this.breathPressure=b,this.reedStiffness=k,this.noiseLevel=P,this.lpf={x1:0,y1:0,cutoff:L},this.hpf={x1:0,y1:0,cutoff:A},this.envelope=0,this.attackTime=N,this.releaseTime=x,this.gate=!1,this.vibratoAmount=O,this.vibratoRate=S,this.vibratoPhase=0,this.frequency=g,this.targetFrequency=g,this.isPlaying=!1}setFrequency(e){this.targetFrequency=e;const t=Math.floor(this.sampleRate/e);(!this.delayLine||t!==this.delayLength)&&(this.delayLength=t,this.delayLine=new Float32Array(this.delayLength),this.delayLine.fill(0),this.readPos=0,this.writePos=0)}reedReflection(e){const t=this.reedStiffness*T+D,i=e*t;if(i>l)return 1;if(i<-l)return-1;const s=i*i;return i*(c+s)/(c+m*s)}lowpass(e,t){const i=t;return this.lpf.y1=i*e+(1-i)*this.lpf.y1,this.lpf.y1}highpass(e,t){const s=t*(this.hpf.y1+e-this.hpf.x1);return this.hpf.x1=e,this.hpf.y1=s,s}saturate(e){if(e>l)return 1;if(e<-l)return-1;const t=e*e;return e*(c+t)/(c+m*t)}generateNoise(){return(Math.random()*2-1)*this.noiseLevel}updateEnvelope(e){if(this.gate){const t=1/(this.attackTime*this.sampleRate);this.envelope+=t*e,this.envelope>1&&(this.envelope=1)}else{const t=1/(this.releaseTime*this.sampleRate);this.envelope-=t*e,this.envelope<0&&(this.envelope=0,this.isPlaying=!1)}return this.envelope}process(){if(!this.delayLine||this.delayLength===0)return 0;const e=this.updateEnvelope(1);if(e<=.001)return 0;this.vibratoPhase+=this.vibratoRate*2*Math.PI/this.sampleRate,this.vibratoPhase>2*Math.PI&&(this.vibratoPhase-=2*Math.PI);const t=Math.sin(this.vibratoPhase)*this.vibratoAmount,s=this.sampleRate/this.targetFrequency*(1+t),n=Math.min(s,this.delayLength-1),u=(this.writePos-n+this.delayLength)%this.delayLength,d=Math.floor(u),p=u-d,v=(d+1)%this.delayLength,f=this.delayLine[d]*(1-p)+this.delayLine[v]*p,w=this.generateNoise(),E=this.breathPressure*e+w*e-f,C=this.reedReflection(E);let a=f+C*.5;return a=this.lowpass(a,this.lpf.cutoff),a=this.highpass(a,this.hpf.cutoff),a=this.saturate(a*F),this.delayLine[this.writePos]=a,this.writePos=(this.writePos+1)%this.delayLength,a*e*B}noteOn(e){if(this.setFrequency(e),this.gate=!0,this.isPlaying=!0,this.vibratoPhase=0,this.delayLine)for(let t=0;t<this.delayLength;t++)this.delayLine[t]=(Math.random()*2-1)*R}noteOff(){this.gate=!1}setBreath(e){this.breathPressure=e*.8+.2}setReedStiffness(e){this.reedStiffness=e}setNoise(e){this.noiseLevel=e*.3}setAttack(e){this.attackTime=e*.1+.001}setRelease(e){this.releaseTime=e*.3+.01}setDamping(e){this.lpf.cutoff=.3+e*.69}setBrightness(e){this.hpf.cutoff=e*.05}setVibrato(e){this.vibratoAmount=e*.01}}class M{constructor(){this.audioContext=null,this.workletNode=null,this.scriptNode=null,this.engine=null,this.analyser=null,this.gainNode=null,this.isActive=!1,this.useWorklet=!1}async initialize(){console.log("ClarinetProcessor.initialize()"),this.audioContext=new(window.AudioContext||window.webkitAudioContext),this._installIOSUnlock(this.audioContext),console.log(`[ClarinetProcessor] audioContext.state after installIOSUnlock: ${this.audioContext.state}`),this.audioContext.state!=="running"&&(await this.audioContext.resume(),console.log(`[ClarinetProcessor] audioContext.resume() called in initialize, new state: ${this.audioContext.state}`)),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=1,console.log(`[ClarinetProcessor] gainNode.gain.value: ${this.gainNode.gain.value}`),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048;try{await this.audioContext.audioWorklet.addModule(new URL(""+new URL("clarinet-worklet-BunK7_GC.js",import.meta.url).href,import.meta.url)),this.workletNode=new AudioWorkletNode(this.audioContext,"clarinet-worklet"),console.log(`[ClarinetProcessor] audioContext.state before connecting workletNode: ${this.audioContext.state}`),this.workletNode.connect(this.gainNode),this.gainNode.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.useWorklet=!0,console.log("[ClarinetProcessor] Using AudioWorklet for audio processing")}catch(e){console.warn("[ClarinetProcessor] AudioWorklet not available, falling back to ScriptProcessor:",e),console.error("[ClarinetProcessor] AudioWorklet initialization error details:",e),this.engine=new _(this.audioContext.sampleRate),this.scriptNode=this.audioContext.createScriptProcessor(2048,0,1),this.scriptNode.onaudioprocess=t=>{const i=t.outputBuffer.getChannelData(0);for(let s=0;s<i.length;s++)i[s]=this.engine.process()},this.scriptNode.connect(this.gainNode),this.gainNode.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.useWorklet=!1,console.log("[ClarinetProcessor] Using ScriptProcessorNode for audio processing")}this.isActive=!0,console.log(`[ClarinetProcessor] audioContext.destination.maxChannelCount: ${this.audioContext.destination.maxChannelCount}`),this.isActive=!0,console.log(`[ClarinetProcessor] audioContext.destination.maxChannelCount: ${this.audioContext.destination.maxChannelCount}`)}async noteOn(e){console.log(`[ClarinetProcessor] noteOn: ${e}, audioContext.state: ${this.audioContext.state}`),this.audioContext.state!=="running"&&(console.log("[ClarinetProcessor] Resuming audio context from noteOn..."),await this.audioContext.resume(),console.log(`[ClarinetProcessor] audioContext.state after resume: ${this.audioContext.state}`)),this.useWorklet&&this.workletNode?this.workletNode.port.postMessage({type:"noteOn",data:{frequency:e}}):this.engine&&this.engine.noteOn(e)}_installIOSUnlock(e){if(!e)return;let t=e.state==="running";console.log(`[ClarinetProcessor] _installIOSUnlock: initial state=${e.state}, unlocked=${t}`);const i=()=>{document.removeEventListener("pointerdown",s,!0),document.removeEventListener("touchstart",s,!0),document.removeEventListener("keydown",s,!0),console.log("[ClarinetProcessor] _installIOSUnlock: cleanup done.")};async function s(){if(console.log(`[ClarinetProcessor] _installIOSUnlock: unlock called, unlocked=${t}, ctx.state=${e.state}`),!t)try{e.state!=="running"&&(await e.resume(),console.log(`[ClarinetProcessor] _installIOSUnlock: ctx.resume() called, new state=${e.state}`));const n=e.createBuffer(1,1,e.sampleRate),o=e.createBufferSource();o.buffer=n,o.connect(e.destination),o.start(0),setTimeout(()=>o.disconnect(),0),t=!0,i(),console.log("[audio] iOS unlocked")}catch(n){console.warn("[audio] unlock failed",n)}}document.addEventListener("pointerdown",s,{capture:!0,passive:!0}),document.addEventListener("touchstart",s,{capture:!0,passive:!0}),document.addEventListener("keydown",s,{capture:!0}),e.onstatechange=()=>console.log("[audio] state:",e.state)}noteOff(){this.useWorklet&&this.workletNode?this.workletNode.port.postMessage({type:"noteOff"}):this.engine&&this.engine.noteOff()}setParameter(e,t){if(console.log(`[ClarinetProcessor] setParameter: ${e}, ${t}`),this.useWorklet&&this.workletNode)this.workletNode.port.postMessage({type:"setParameter",data:{param:e,value:t}});else if(this.engine)switch(e){case"breath":this.engine.setBreath(t);break;case"reed":this.engine.setReedStiffness(t);break;case"noise":this.engine.setNoise(t);break;case"attack":this.engine.setAttack(t);break;case"release":this.engine.setRelease(t);break;case"damping":this.engine.setDamping(t);break;case"brightness":this.engine.setBrightness(t);break;case"vibrato":this.engine.setVibrato(t);break}}getAnalyserData(){if(!this.analyser)return null;const e=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteTimeDomainData(e),e}shutdown(){this.workletNode&&this.workletNode.disconnect(),this.scriptNode&&this.scriptNode.disconnect(),this.gainNode&&this.gainNode.disconnect(),this.analyser&&this.analyser.disconnect(),this.audioContext&&this.audioContext.close(),this.isActive=!1}}class r{constructor(e,t,i,s=0,n=100,o=50){this.element=e,this.valueElement=t,this.onChange=i,this.min=s,this.max=n,this.value=o,this.isDragging=!1,this.startY=0,this.startValue=0,this.setupListeners(),this.updateDisplay()}setupListeners(){this.element.addEventListener("mousedown",e=>{this.isDragging=!0,this.startY=e.clientY,this.startValue=this.value,e.preventDefault()}),document.addEventListener("mousemove",e=>{if(this.isDragging){const t=(this.startY-e.clientY)*.5;this.value=Math.max(this.min,Math.min(this.max,this.startValue+t)),this.updateDisplay(),this.onChange(this.value/100)}}),document.addEventListener("mouseup",()=>{this.isDragging=!1}),this.element.addEventListener("touchstart",e=>{this.isDragging=!0,this.startY=e.touches[0].clientY,this.startValue=this.value,e.preventDefault()}),document.addEventListener("touchmove",e=>{if(this.isDragging){const t=(this.startY-e.touches[0].clientY)*.5;this.value=Math.max(this.min,Math.min(this.max,this.startValue+t)),this.updateDisplay(),this.onChange(this.value/100)}}),document.addEventListener("touchend",()=>{this.isDragging=!1}),this.element.addEventListener("dblclick",()=>{this.value=(this.min+this.max)/2,this.updateDisplay(),this.onChange(this.value/100)})}updateDisplay(){const e=this.value/100*270-135;this.element.style.transform=`rotate(${e}deg)`,this.valueElement.textContent=Math.round(this.value)}setValue(e){this.value=Math.max(this.min,Math.min(this.max,e)),this.updateDisplay()}}class U{constructor(e,t,i){this.container=e,this.onNoteOn=t,this.onNoteOff=i,this.activeKeys=new Set,this.keyMap=this.createKeyMap(),this.setupListeners()}createKeyMap(){return{a:"C4",w:"C#4",s:"D4",e:"D#4",d:"E4",f:"F4",t:"F#4",g:"G4",y:"G#4",h:"A4",u:"A#4",j:"B4",k:"C5"}}noteToFrequency(e){return{C4:261.63,"C#4":277.18,D4:293.66,"D#4":311.13,E4:329.63,F4:349.23,"F#4":369.99,G4:392,"G#4":415.3,A4:440,"A#4":466.16,B4:493.88,C5:523.25}[e]||440}setupListeners(){this.container.querySelectorAll(".key").forEach(t=>{const i=t.dataset.note;t.addEventListener("mousedown",s=>{s.preventDefault(),this.pressKey(i)}),t.addEventListener("mouseup",()=>{this.releaseKey(i)}),t.addEventListener("mouseleave",()=>{this.activeKeys.has(i)&&this.releaseKey(i)}),t.addEventListener("touchstart",s=>{s.preventDefault(),this.pressKey(i)}),t.addEventListener("touchend",s=>{s.preventDefault(),this.releaseKey(i)})}),document.addEventListener("keydown",t=>{const i=this.keyMap[t.key.toLowerCase()];i&&!this.activeKeys.has(i)&&this.pressKey(i)}),document.addEventListener("keyup",t=>{const i=this.keyMap[t.key.toLowerCase()];i&&this.releaseKey(i)})}pressKey(e){if(this.activeKeys.has(e))return;console.log(`[KeyboardController] pressKey: ${e}`),this.activeKeys.add(e);const t=this.container.querySelector(`[data-note="${e}"]`);t&&t.classList.add("active");const i=this.noteToFrequency(e);try{this.onNoteOn(e,i)}catch(s){console.error("[KeyboardController] Error calling onNoteOn:",s)}}releaseKey(e){if(!this.activeKeys.has(e))return;this.activeKeys.delete(e);const t=this.container.querySelector(`[data-note="${e}"]`);t&&t.classList.remove("active"),this.onNoteOff(e)}releaseAllKeys(){this.activeKeys.forEach(e=>{this.releaseKey(e)})}}class K{constructor(e){this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.isRunning=!1,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const e=this.canvas.getBoundingClientRect();this.canvas.width=e.width,this.canvas.height=e.height}start(e){this.isRunning=!0,this.dataFunction=e,this.draw()}stop(){this.isRunning=!1}draw(){if(!this.isRunning)return;const e=this.dataFunction();if(this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),e){this.ctx.lineWidth=2,this.ctx.strokeStyle="#4a9eff",this.ctx.beginPath();const t=this.canvas.width/e.length;let i=0;for(let s=0;s<e.length;s++){const o=e[s]/128*this.canvas.height/2;s===0?this.ctx.moveTo(i,o):this.ctx.lineTo(i,o),i+=t}this.ctx.stroke()}requestAnimationFrame(()=>this.draw())}}class y{constructor(){this.processor=null,this.keyboard=null,this.visualizer=null,this.knobs={},this.isActive=!1,this.currentNote=null,this.initializeUI()}initializeUI(){document.getElementById("power-button").addEventListener("click",()=>this.togglePower()),this.knobs.breath=new r(document.getElementById("breath-knob"),document.getElementById("breath-value"),t=>this.updateParameter("breath",t),0,100,70),this.knobs.reed=new r(document.getElementById("reed-knob"),document.getElementById("reed-value"),t=>this.updateParameter("reed",t),0,100,50),this.knobs.noise=new r(document.getElementById("noise-knob"),document.getElementById("noise-value"),t=>this.updateParameter("noise",t),0,100,15),this.knobs.attack=new r(document.getElementById("attack-knob"),document.getElementById("attack-value"),t=>this.updateParameter("attack",t),0,100,10),this.knobs.damping=new r(document.getElementById("damping-knob"),document.getElementById("damping-value"),t=>this.updateParameter("damping",t),0,100,20),this.knobs.brightness=new r(document.getElementById("brightness-knob"),document.getElementById("brightness-value"),t=>this.updateParameter("brightness",t),0,100,70),this.knobs.vibrato=new r(document.getElementById("vibrato-knob"),document.getElementById("vibrato-value"),t=>this.updateParameter("vibrato",t),0,100,0),this.knobs.release=new r(document.getElementById("release-knob"),document.getElementById("release-value"),t=>this.updateParameter("release",t),0,100,50),this.keyboard=new U(document.getElementById("keyboard"),(t,i)=>this.handleNoteOn(t,i),t=>this.handleNoteOff(t)),this.visualizer=new K(document.getElementById("visualizer")),this.updateStatus()}async togglePower(){this.isActive?this.powerOff():await this.powerOn()}async powerOn(){try{this.processor=new M,await this.processor.initialize(),console.log(`main this.processor.isActive = ${this.processor.isActive}`),this.updateParameter("breath",this.knobs.breath.value/100),this.updateParameter("reed",this.knobs.reed.value/100),this.updateParameter("noise",this.knobs.noise.value/100),this.updateParameter("attack",this.knobs.attack.value/100),this.updateParameter("damping",this.knobs.damping.value/100),this.updateParameter("brightness",this.knobs.brightness.value/100),this.updateParameter("vibrato",this.knobs.vibrato.value/100),this.updateParameter("release",this.knobs.release.value/100),this.visualizer.start(()=>this.processor.getAnalyserData()),this.isActive=!0,document.getElementById("power-button").classList.add("active"),this.updateStatus(),console.log("Clarinet synthesizer powered on")}catch(e){console.error("Failed to initialize audio:",e),alert("Failed to initialize audio. Please check browser compatibility.")}}powerOff(){this.processor&&(this.keyboard.releaseAllKeys(),this.processor.shutdown(),this.processor=null),this.visualizer.stop(),this.isActive=!1,this.currentNote=null,document.getElementById("power-button").classList.remove("active"),this.updateStatus(),console.log("Clarinet synthesizer powered off")}handleNoteOn(e,t){this.isActive&&(console.log(`[ClarinetSynthApp] handleNoteOn: ${e}, ${t}`),this.currentNote=e,this.processor.noteOn(t),this.updateStatus())}handleNoteOff(e){this.isActive&&this.currentNote===e&&(this.processor.noteOff(),this.currentNote=null,this.updateStatus())}updateParameter(e,t){console.log(`[ClarinetSynthApp] updateParameter: ${e}, ${t}`),this.processor&&this.processor.isActive&&this.processor.setParameter(e,t)}updateStatus(){const e=document.getElementById("status"),t=document.getElementById("current-note");e.textContent=this.isActive?"ON":"OFF",e.style.color=this.isActive?"#4eff4a":"#ff4a4a",t.textContent=this.currentNote||"---",this.isActive?this.updateCPU():document.getElementById("cpu").textContent="0%"}updateCPU(){const e=this.processor&&this.processor.engine&&this.processor.engine.isPlaying?Math.floor(15+Math.random()*10):Math.floor(5+Math.random()*5);document.getElementById("cpu").textContent=e+"%",this.isActive&&setTimeout(()=>this.updateCPU(),100)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.synthApp=new y}):window.synthApp=new y;window.addEventListener("beforeunload",()=>{window.synthApp&&window.synthApp.isActive&&window.synthApp.powerOff()});
