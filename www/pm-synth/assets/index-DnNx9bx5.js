(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class k{constructor(t=44100){this.sampleRate=t,this.dcLevel=.5,this.noiseLevel=.15,this.toneLevel=0,this.sawtoothPhase=0,this.sawtoothFrequency=440}setDCLevel(t){this.dcLevel=Math.max(0,Math.min(1,t))}setNoiseLevel(t){this.noiseLevel=Math.max(0,Math.min(1,t))}setToneLevel(t){this.toneLevel=Math.max(0,Math.min(1,t))}process(t){this.sawtoothFrequency=t;const e=this.dcLevel,i=(Math.random()*2-1)*this.noiseLevel,s=this.sawtoothFrequency/this.sampleRate;this.sawtoothPhase+=s,this.sawtoothPhase>=1&&(this.sawtoothPhase-=1);const n=(this.sawtoothPhase*2-1)*this.toneLevel;return e+i+n}reset(){this.sawtoothPhase=0}}class F{constructor(t=44100){this.sampleRate=t,this.attackTime=.01,this.releaseTime=.05,this.envelope=0,this.gate=!1,this.isActive=!1}setAttack(t){this.attackTime=.001*Math.pow(500,t)}setRelease(t){this.releaseTime=.01*Math.pow(200,t)}setGate(t){this.gate=t,t&&(this.isActive=!0)}process(){if(this.gate){const t=1/(this.attackTime*this.sampleRate);this.envelope+=t,this.envelope>1&&(this.envelope=1)}else{const t=1/(this.releaseTime*this.sampleRate);this.envelope-=t,this.envelope<0&&(this.envelope=0,this.isActive=!1)}return this.envelope}isPlaying(){return this.isActive}reset(){this.envelope=0,this.isActive=!0}}const m={PLUCK:0,HIT:1,REED:2,FLUTE:3,BRASS:4,BOW:5,BELL:6,DRUM:7};class P{constructor(){this.type=m.REED,this.intensity=.5,this.lastPeak=0,this.peakDecay=.999,this.prevInput=0,this.bowState=0,this.bellPhase=0,this.drumEnergy=0,this.TANH_CLIP_THRESHOLD=3,this.TANH_NUMERATOR_CONSTANT=27,this.TANH_DENOMINATOR_SCALE=9}setType(t){t>=m.PLUCK&&t<=m.BRASS&&(this.type=t)}setIntensity(t){this.intensity=Math.max(0,Math.min(1,t))}fastTanh(t){if(t>this.TANH_CLIP_THRESHOLD)return 1;if(t<-this.TANH_CLIP_THRESHOLD)return-1;const e=t*t;return t*(this.TANH_NUMERATOR_CONSTANT+e)/(this.TANH_NUMERATOR_CONSTANT+this.TANH_DENOMINATOR_SCALE*e)}processPluck(t){const e=.2+this.intensity*.45;let i;if(Math.abs(t)>Math.abs(this.lastPeak))this.lastPeak=t,i=t;else{this.lastPeak*=this.peakDecay;const s=(t-this.prevInput)*e,n=.35+(1-this.intensity)*.45;i=t*n+s}return this.prevInput=t,Math.max(-1,Math.min(1,i))}processHit(t){const e=2+this.intensity*8,i=Math.sin(t*e*Math.PI*.5),s=.35+this.intensity*.55,n=Math.sign(i)*Math.pow(Math.abs(i),s);return Math.max(-1,Math.min(1,n))}processReed(t){const e=2.5+this.intensity*10,i=(this.intensity-.5)*.25,s=(t+i)*e,n=this.fastTanh(s),o=.6+this.intensity*.5;return Math.max(-1,Math.min(1,n*o-i*.3))}processFlute(t){const e=.45+this.intensity*.4,i=(Math.random()*2-1)*this.intensity*.04,s=(t+i)*e,n=s-s*s*s*.35;return Math.max(-.49,Math.min(.49,n))}processBrass(t){const e=1.5+this.intensity*5;.4+this.intensity*.5;let i;if(t>=0){const n=t*e+(.2+this.intensity*.35);i=this.fastTanh(Math.max(n,0))}else{const n=-t*(e*(.4+this.intensity*.4));i=-Math.pow(Math.min(n,1.5),1.3)*(.35+(1-this.intensity)*.25)}const s=this.fastTanh(i*(1.2+this.intensity*1.5));return Math.max(-1,Math.min(1,s+this.intensity*.05))}processBow(t){const e=this.intensity*.9+.2,i=t-this.bowState,s=this.fastTanh(i*(6+this.intensity*12)),n=(Math.random()*2-1)*this.intensity*.012,o=s*(.55+this.intensity*.35)+i*.25+n,h=.8-this.intensity*.25;return this.bowState=this.bowState*h+(t+s*e*.05)*(1-h),Math.max(-1,Math.min(1,o))}processBell(t){this.bellPhase+=.1+this.intensity*.25,this.bellPhase>Math.PI*2&&(this.bellPhase-=Math.PI*2);const e=6+this.intensity*14,i=Math.sin(t*e+this.bellPhase)*(.4+this.intensity*.4),s=Math.sin(t*(e*.5+2))*(.2+this.intensity*.3),n=this.fastTanh((i+s)*(1.1+this.intensity*.6));return Math.max(-1,Math.min(1,n))}processDrum(t){const e=1.2+this.intensity*2.2,i=(Math.random()*2-1)*(.02+this.intensity*.06);this.drumEnergy=this.drumEnergy*(.7-this.intensity*.2)+Math.abs(t)*(.6+this.intensity*.7);const s=Math.tanh(t*e)+i,n=s*(.4+this.intensity*.4)+Math.sign(s)*Math.min(.8,this.drumEnergy*.6);return Math.max(-1,Math.min(1,n))}process(t){switch(this.type){case m.PLUCK:return this.processPluck(t);case m.HIT:return this.processHit(t);case m.REED:return this.processReed(t);case m.FLUTE:return this.processFlute(t);case m.BRASS:return this.processBrass(t);case m.BOW:return this.processBow(t);case m.BELL:return this.processBell(t);case m.DRUM:return this.processDrum(t);default:return t}}reset(){this.lastPeak=0,this.prevInput=0,this.bowState=0,this.bellPhase=0,this.drumEnergy=0}}class M{constructor(t=44100){this.sampleRate=t,this.maxDelayLength=Math.floor(t/20),this.delayLine1=new Float32Array(this.maxDelayLength),this.delayLine2=new Float32Array(this.maxDelayLength),this.writePos1=0,this.writePos2=0,this.tuningSemitones=0,this.ratio=1,this.delayLength1=1e3,this.delayLength2=1e3,this.frequency=440}setTuning(t){this.tuningSemitones=(t-.5)*24,this.frequency&&this.updateDelayLengths(this.frequency)}setRatio(t){t<.5?this.ratio=.5+t:this.ratio=1+(t-.5)*2,this.frequency&&this.updateDelayLengths(this.frequency)}updateDelayLengths(t){this.frequency=t;const e=Math.pow(2,this.tuningSemitones/12),i=t*e;this.delayLength1=Math.max(2,Math.min(this.sampleRate/i,this.maxDelayLength-1)),this.delayLength2=Math.max(2,Math.min(this.delayLength1*this.ratio,this.maxDelayLength-1))}process(t,e){e!==this.frequency&&this.updateDelayLengths(e);const s=(this.writePos1-this.delayLength1+this.maxDelayLength)%this.maxDelayLength,n=Math.floor(s),o=s-n,h=(n+1)%this.maxDelayLength,l=this.delayLine1[n]*(1-o)+this.delayLine1[h]*o,d=(this.writePos2-this.delayLength2+this.maxDelayLength)%this.maxDelayLength,c=Math.floor(d),p=d-c,y=(c+1)%this.maxDelayLength,f=this.delayLine2[c]*(1-p)+this.delayLine2[y]*p;return this.delayLine1[this.writePos1]=t,this.delayLine2[this.writePos2]=t,this.writePos1=(this.writePos1+1)%this.maxDelayLength,this.writePos2=(this.writePos2+1)%this.maxDelayLength,{delay1:l,delay2:f}}reset(){this.delayLine1.fill(0),this.delayLine2.fill(0),this.writePos1=0,this.writePos2=0;for(let t=0;t<Math.min(100,this.maxDelayLength);t++)this.delayLine1[t]=(Math.random()*2-1)*.01,this.delayLine2[t]=(Math.random()*2-1)*.01}}class D{constructor(){this.delay1Gain=.95,this.delay2Gain=.95,this.filterGain=0}setDelay1Gain(t){this.delay1Gain=t*.99}setDelay2Gain(t){this.delay2Gain=t*.99}setFilterGain(t){this.filterGain=t*.99}process(t,e,i){return t*this.delay1Gain+e*this.delay2Gain+i*this.filterGain}reset(){}}class A{constructor(t=44100){this.sampleRate=t,this.frequency=1e3,this.q=1,this.shape=0,this.low=0,this.band=0,this.high=0,this.prevLow=0,this.prevBand=0}setFrequency(t){this.frequency=20*Math.pow(1e3,t)}setQ(t){this.q=.5*Math.pow(40,t)}setShape(t){this.shape=Math.max(0,Math.min(1,t))}process(t){const e=2*Math.sin(Math.PI*this.frequency/this.sampleRate),i=1/Math.max(.5,this.q);this.low=this.low+e*this.band,this.high=t-this.low-i*this.band,this.band=e*this.high+this.band,isFinite(this.low)||(this.low=0),isFinite(this.band)||(this.band=0),isFinite(this.high)||(this.high=0);let s;if(this.shape<.5){const n=this.shape*2;s=this.low*(1-n)+this.band*n}else{const n=(this.shape-.5)*2;s=this.band*(1-n)+this.high*n}return s}reset(){this.low=0,this.band=0,this.high=0,this.prevLow=0,this.prevBand=0}}class I{constructor(t=44100){this.sampleRate=t,this.lfoFrequency=5,this.lfoPhase=0,this.typeLevel=.5,this.amDepth=0,this.fmDepth=0}setFrequency(t){this.lfoFrequency=.1*Math.pow(200,t)}setTypeLevel(t){this.typeLevel=Math.max(0,Math.min(1,t)),t<.5?(this.amDepth=(.5-t)*2,this.fmDepth=0):(this.amDepth=0,this.fmDepth=(t-.5)*2)}process(){const t=this.lfoFrequency*2*Math.PI/this.sampleRate;this.lfoPhase+=t,this.lfoPhase>2*Math.PI&&(this.lfoPhase-=2*Math.PI);const e=Math.sin(this.lfoPhase),i=1-this.amDepth*.5+e*this.amDepth*.5,s=1+e*this.fmDepth*.1;return{lfo:e,am:i,fm:s}}reset(){this.lfoPhase=0}}class T{constructor(t){this.sampleRate=t,this.size=.5,this.level=.3,this.combDelays=[Math.floor(.0297*t),Math.floor(.0371*t),Math.floor(.0411*t),Math.floor(.0437*t)],this.allpassDelays=[Math.floor(.005*t),Math.floor(.0017*t)],this.combBuffers=this.combDelays.map(e=>new Float32Array(e)),this.combIndices=new Array(this.combDelays.length).fill(0),this.allpassBuffers=this.allpassDelays.map(e=>new Float32Array(e)),this.allpassIndices=new Array(this.allpassDelays.length).fill(0)}setSize(t){this.size=Math.max(0,Math.min(1,t))}setLevel(t){this.level=Math.max(0,Math.min(1,t))}process(t){let e=0;const i=.7+this.size*.28;for(let n=0;n<this.combBuffers.length;n++){const o=this.combBuffers[n],h=this.combIndices[n],l=this.combDelays[n],r=o[h];o[h]=t+r*i,e+=r,this.combIndices[n]=(h+1)%l}let s=e/this.combBuffers.length;for(let n=0;n<this.allpassBuffers.length;n++){const o=this.allpassBuffers[n],h=this.allpassIndices[n],l=this.allpassDelays[n],r=o[h],d=.5,c=-s*d+r;o[h]=s+r*d,s=c,this.allpassIndices[n]=(h+1)%l}return t*(1-this.level)+s*this.level}reset(){this.combBuffers.forEach(t=>t.fill(0)),this.allpassBuffers.forEach(t=>t.fill(0)),this.combIndices.fill(0),this.allpassIndices.fill(0)}}class S{constructor(t=44100){this.sampleRate=t,this.sources=new k(t),this.envelope=new F(t),this.interface=new P,this.delayLines=new M(t),this.feedback=new D,this.filter=new A(t),this.modulation=new I(t),this.reverb=new T(t),this.frequency=440,this.gate=!1,this.isPlaying=!1,this.outputGain=.5,this.dcBlockerX1=0,this.dcBlockerY1=0,this.prevDelayOutputs={delay1:0,delay2:0},this.prevFilterOutput=0}noteOn(t){this.frequency=t,this.gate=!0,this.isPlaying=!0,this.sources.reset(),this.envelope.reset(),this.interface.reset(),this.delayLines.reset(),this.feedback.reset(),this.filter.reset(),this.modulation.reset(),this.reverb.reset(),this.dcBlockerX1=0,this.dcBlockerY1=0,this.prevDelayOutputs.delay1=0,this.prevDelayOutputs.delay2=0,this.prevFilterOutput=0,this.envelope.setGate(!0)}noteOff(){this.gate=!1,this.envelope.setGate(!1)}process(){if(!this.isPlaying)return 0;const t=this.modulation.process(),e=this.frequency*t.fm,i=this.sources.process(e),s=this.envelope.process(),n=i*s,o=this.interface.process(n),h=this.feedback.process(this.prevDelayOutputs.delay1,this.prevDelayOutputs.delay2,this.prevFilterOutput),l=o+h,r=this.dcBlock(l),d=Math.max(-1,Math.min(1,r)),c=this.delayLines.process(d,this.frequency),p=(c.delay1+c.delay2)*.5,y=this.filter.process(p),f=y*t.am*this.outputGain,g=this.reverb.process(f);return this.prevDelayOutputs.delay1=c.delay1,this.prevDelayOutputs.delay2=c.delay2,this.prevFilterOutput=y,!this.envelope.isPlaying()&&Math.abs(g)<1e-5&&Math.abs(this.prevDelayOutputs.delay1)<1e-5&&Math.abs(this.prevDelayOutputs.delay2)<1e-5&&(this.isPlaying=!1),g}dcBlock(t){const e=t-this.dcBlockerX1+.995*this.dcBlockerY1;return this.dcBlockerX1=t,this.dcBlockerY1=e,e}setDCLevel(t){this.sources.setDCLevel(t)}setNoiseLevel(t){this.sources.setNoiseLevel(t)}setToneLevel(t){this.sources.setToneLevel(t)}setAttack(t){this.envelope.setAttack(t)}setRelease(t){this.envelope.setRelease(t)}setInterfaceType(t){this.interface.setType(t)}setInterfaceIntensity(t){this.interface.setIntensity(t)}setTuning(t){this.delayLines.setTuning(t)}setRatio(t){this.delayLines.setRatio(t)}setDelay1Feedback(t){this.feedback.setDelay1Gain(t)}setDelay2Feedback(t){this.feedback.setDelay2Gain(t)}setFilterFeedback(t){this.feedback.setFilterGain(t)}setFilterFrequency(t){this.filter.setFrequency(t)}setFilterQ(t){this.filter.setQ(t)}setFilterShape(t){this.filter.setShape(t)}setLFOFrequency(t){this.modulation.setFrequency(t)}setModulationTypeLevel(t){this.modulation.setTypeLevel(t)}setReverbSize(t){this.reverb.setSize(t)}setReverbLevel(t){this.reverb.setLevel(t)}getIsPlaying(){return this.isPlaying}}const B=""+new URL("pm-synth-worklet-DfLkvfOi.js",import.meta.url).href;class x{constructor(){this.audioContext=null,this.workletNode=null,this.scriptNode=null,this.engine=null,this.analyser=null,this.gainNode=null,this.isActive=!1,this.useWorklet=!1}async initialize(){console.log("[PMSynthProcessor] Initializing..."),this.audioContext=new(window.AudioContext||window.webkitAudioContext),this._installIOSUnlock(this.audioContext),console.log(`[PMSynthProcessor] audioContext.state: ${this.audioContext.state}`),this.audioContext.state!=="running"&&(await this.audioContext.resume(),console.log(`[PMSynthProcessor] audioContext resumed, state: ${this.audioContext.state}`)),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=1,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048;try{await this.audioContext.audioWorklet.addModule(B),this.workletNode=new AudioWorkletNode(this.audioContext,"pm-synth-worklet"),this.workletNode.connect(this.gainNode),this.gainNode.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.useWorklet=!0,console.log("[PMSynthProcessor] Using AudioWorklet")}catch(t){console.warn("[PMSynthProcessor] AudioWorklet not available, using ScriptProcessor:",t),this.engine=new S(this.audioContext.sampleRate),this.scriptNode=this.audioContext.createScriptProcessor(2048,0,1),this.scriptNode.onaudioprocess=e=>{const i=e.outputBuffer.getChannelData(0);for(let s=0;s<i.length;s++)i[s]=this.engine.process()},this.scriptNode.connect(this.gainNode),this.gainNode.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.useWorklet=!1,console.log("[PMSynthProcessor] Using ScriptProcessorNode")}this.isActive=!0}async noteOn(t){console.log(`[PMSynthProcessor] noteOn: ${t}Hz`),this.audioContext.state!=="running"&&await this.audioContext.resume(),this.useWorklet&&this.workletNode?this.workletNode.port.postMessage({type:"noteOn",data:{frequency:t}}):this.engine&&this.engine.noteOn(t)}noteOff(){this.useWorklet&&this.workletNode?this.workletNode.port.postMessage({type:"noteOff"}):this.engine&&this.engine.noteOff()}setParameter(t,e){if(this.useWorklet&&this.workletNode)this.workletNode.port.postMessage({type:"setParameter",data:{param:t,value:e}});else if(this.engine)switch(t){case"dcLevel":this.engine.setDCLevel(e);break;case"noiseLevel":this.engine.setNoiseLevel(e);break;case"toneLevel":this.engine.setToneLevel(e);break;case"attack":this.engine.setAttack(e);break;case"release":this.engine.setRelease(e);break;case"interfaceType":this.engine.setInterfaceType(e);break;case"interfaceIntensity":this.engine.setInterfaceIntensity(e);break;case"tuning":this.engine.setTuning(e);break;case"ratio":this.engine.setRatio(e);break;case"delay1Feedback":this.engine.setDelay1Feedback(e);break;case"delay2Feedback":this.engine.setDelay2Feedback(e);break;case"filterFeedback":this.engine.setFilterFeedback(e);break;case"filterFrequency":this.engine.setFilterFrequency(e);break;case"filterQ":this.engine.setFilterQ(e);break;case"filterShape":this.engine.setFilterShape(e);break;case"lfoFrequency":this.engine.setLFOFrequency(e);break;case"modulationTypeLevel":this.engine.setModulationTypeLevel(e);break}}getAnalyserData(){if(!this.analyser||!this.audioContext)return null;const t=new Float32Array(this.analyser.fftSize);this.analyser.getFloatTimeDomainData(t);const e=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteFrequencyData(e),{timeDomain:t,frequencyDomain:e,sampleRate:this.audioContext.sampleRate}}_installIOSUnlock(t){if(!t)return;let e=t.state==="running";const i=()=>{document.removeEventListener("pointerdown",s,!0),document.removeEventListener("touchstart",s,!0),document.removeEventListener("keydown",s,!0)},s=async()=>{if(!e)try{t.state!=="running"&&await t.resume();const n=t.createBuffer(1,1,t.sampleRate),o=t.createBufferSource();o.buffer=n,o.connect(t.destination),o.start(0),setTimeout(()=>o.disconnect(),0),e=!0,i(),console.log("[PMSynthProcessor] iOS audio unlocked")}catch(n){console.warn("[PMSynthProcessor] unlock failed",n)}};document.addEventListener("pointerdown",s,{capture:!0,passive:!0}),document.addEventListener("touchstart",s,{capture:!0,passive:!0}),document.addEventListener("keydown",s,{capture:!0}),t.onstatechange=()=>console.log("[PMSynthProcessor] state:",t.state)}shutdown(){this.workletNode&&this.workletNode.disconnect(),this.scriptNode&&this.scriptNode.disconnect(),this.gainNode&&this.gainNode.disconnect(),this.analyser&&this.analyser.disconnect(),this.audioContext&&this.audioContext.close(),this.isActive=!1}}class u{constructor(t,e,i,s=0,n=100,o=50,h=!1){this.element=t,this.valueElement=e,this.onChange=i,this.min=s,this.max=n,this.value=o,this.bipolar=h,this.isDragging=!1,this.startY=0,this.startValue=0,this.setupListeners(),this.updateDisplay()}setupListeners(){this.element.addEventListener("mousedown",t=>{this.isDragging=!0,this.startY=t.clientY,this.startValue=this.value,t.preventDefault()}),document.addEventListener("mousemove",t=>{if(this.isDragging){const e=(this.startY-t.clientY)*.5;this.value=Math.max(this.min,Math.min(this.max,this.startValue+e)),this.updateDisplay(),this.onChange(this.value/100)}}),document.addEventListener("mouseup",()=>{this.isDragging=!1}),this.element.addEventListener("touchstart",t=>{this.isDragging=!0,this.startY=t.touches[0].clientY,this.startValue=this.value,t.preventDefault()}),document.addEventListener("touchmove",t=>{if(this.isDragging){const e=(this.startY-t.touches[0].clientY)*.5;this.value=Math.max(this.min,Math.min(this.max,this.startValue+e)),this.updateDisplay(),this.onChange(this.value/100)}}),document.addEventListener("touchend",()=>{this.isDragging=!1}),this.element.addEventListener("dblclick",()=>{this.value=(this.min+this.max)/2,this.updateDisplay(),this.onChange(this.value/100)})}updateDisplay(){const t=this.value/100*270-135;if(this.element.style.transform=`rotate(${t}deg)`,this.bipolar){const e=Math.round(this.value-50);this.valueElement.textContent=e>=0?`+${e}`:e}else this.valueElement.textContent=Math.round(this.value)}setValue(t){this.value=Math.max(this.min,Math.min(this.max,t)),this.updateDisplay()}}class C{constructor(t,e,i,s,n=0){this.element=t,this.labelElement=e,this.positions=i,this.onChange=s,this.currentPosition=n,this.isDragging=!1,this.startY=0,this.startPosition=0,this.setupListeners(),this.updateDisplay()}setupListeners(){this.element.addEventListener("mousedown",t=>{this.isDragging=!0,this.startY=t.clientY,this.startPosition=this.currentPosition,t.preventDefault()}),document.addEventListener("mousemove",t=>{if(this.isDragging){const e=Math.floor((this.startY-t.clientY)/30),i=Math.max(0,Math.min(this.positions.length-1,this.startPosition+e));i!==this.currentPosition&&(this.currentPosition=i,this.updateDisplay(),this.onChange(this.currentPosition))}}),document.addEventListener("mouseup",()=>{this.isDragging=!1}),this.element.addEventListener("touchstart",t=>{this.isDragging=!0,this.startY=t.touches[0].clientY,this.startPosition=this.currentPosition,t.preventDefault()}),document.addEventListener("touchmove",t=>{if(this.isDragging){const e=Math.floor((this.startY-t.touches[0].clientY)/30),i=Math.max(0,Math.min(this.positions.length-1,this.startPosition+e));i!==this.currentPosition&&(this.currentPosition=i,this.updateDisplay(),this.onChange(this.currentPosition))}}),document.addEventListener("touchend",()=>{this.isDragging=!1}),this.element.addEventListener("click",t=>{this.isDragging||(this.currentPosition=(this.currentPosition+1)%this.positions.length,this.updateDisplay(),this.onChange(this.currentPosition))})}updateDisplay(){const t=180/(this.positions.length-1),e=this.currentPosition*t-90;this.element.style.transform=`rotate(${e}deg)`,this.labelElement.textContent=this.positions[this.currentPosition]}setPosition(t){this.currentPosition=Math.max(0,Math.min(this.positions.length-1,t)),this.updateDisplay()}}class N{constructor(t,e,i){this.container=t,this.onNoteOn=e,this.onNoteOff=i,this.activeKeys=new Set,this.keyMap=this.createKeyMap(),this.setupListeners()}createKeyMap(){return{a:"C4",w:"C#4",s:"D4",e:"D#4",d:"E4",f:"F4",t:"F#4",g:"G4",y:"G#4",h:"A4",u:"A#4",j:"B4",k:"C5",o:"C#5",l:"D5",p:"D#5",";":"E5","'":"F5","]":"F#5",z:"G5",x:"G#5",c:"A5",v:"A#5",b:"B5",n:"C6"}}noteToFrequency(t){return{C4:261.63,"C#4":277.18,D4:293.66,"D#4":311.13,E4:329.63,F4:349.23,"F#4":369.99,G4:392,"G#4":415.3,A4:440,"A#4":466.16,B4:493.88,C5:523.25,"C#5":554.37,D5:587.33,"D#5":622.25,E5:659.25,F5:698.46,"F#5":739.99,G5:783.99,"G#5":830.61,A5:880,"A#5":932.33,B5:987.77,C6:1046.5}[t]||440}setupListeners(){this.container.querySelectorAll(".key").forEach(e=>{const i=e.dataset.note;e.addEventListener("mousedown",s=>{s.preventDefault(),this.pressKey(i)}),e.addEventListener("mouseup",()=>{this.releaseKey(i)}),e.addEventListener("mouseleave",()=>{this.activeKeys.has(i)&&this.releaseKey(i)}),e.addEventListener("touchstart",s=>{s.preventDefault(),this.pressKey(i)}),e.addEventListener("touchend",s=>{s.preventDefault(),this.releaseKey(i)})}),document.addEventListener("keydown",e=>{const i=this.keyMap[e.key.toLowerCase()];i&&!this.activeKeys.has(i)&&this.pressKey(i)}),document.addEventListener("keyup",e=>{const i=this.keyMap[e.key.toLowerCase()];i&&this.releaseKey(i)})}pressKey(t){if(this.activeKeys.has(t))return;console.log(`[KeyboardController] pressKey: ${t}`),this.activeKeys.add(t);const e=this.container.querySelector(`[data-note="${t}"]`);e&&e.classList.add("active");const i=this.noteToFrequency(t);try{this.onNoteOn(t,i)}catch(s){console.error("[KeyboardController] Error calling onNoteOn:",s)}}releaseKey(t){if(!this.activeKeys.has(t))return;this.activeKeys.delete(t);const e=this.container.querySelector(`[data-note="${t}"]`);e&&e.classList.remove("active"),this.onNoteOff(t)}releaseAllKeys(){this.activeKeys.forEach(t=>{this.releaseKey(t)})}}function E(a,t=0,e=a.length){const i=Math.max(1,e-t);let s=0;for(let n=t;n<e;n++){const o=a[n]||0;s+=o*o}return Math.sqrt(s/i)}function b(a){let t=0;for(let e=0;e<a.length;e++){const i=Math.abs(a[e]);i>t&&(t=i)}return t}function O(a){const t=b(a),e=E(a);return e>0?t/e:0}function R(a){let t=0;for(let e=0;e<a.length;e++)t+=a[e]||0;return t/a.length}function _(a){let t=1/0,e=-1/0;for(let i=0;i<a.length;i++){const s=a[i];s<t&&(t=s),s>e&&(e=s)}return e-t}function q(a,t=44100){const e=a.length;if(e===0)return{frequencies:new Float32Array(0),magnitudes:new Float32Array(0)};const i=Math.pow(2,Math.ceil(Math.log2(e))),s=new Float32Array(i),n=new Float32Array(i);for(let r=0;r<i;r++){const d=r<e?a[r]:0,c=.5*(1-Math.cos(2*Math.PI*r/(i-1)));s[r]=d*c,n[r]=0}U(s,n);const o=i/2,h=new Float32Array(o),l=new Float32Array(o);for(let r=0;r<o;r++){const d=s[r],c=n[r];h[r]=Math.sqrt(d*d+c*c),l[r]=r*t/i}return{frequencies:l,magnitudes:h}}function U(a,t){const e=a.length,i=Math.log2(e);if(!Number.isInteger(i))throw new Error("FFT size must be a power of two");for(let s=0;s<e;s++){const n=z(s,i);n>s&&([a[s],a[n]]=[a[n],a[s]],[t[s],t[n]]=[t[n],t[s]])}for(let s=2;s<=e;s<<=1){const n=s>>1,o=2*Math.PI/s;for(let h=0;h<e;h+=s)for(let l=0;l<n;l++){const r=o*l,d=Math.cos(r),c=-Math.sin(r),p=h+l,y=p+n,f=a[y]*d-t[y]*c,g=a[y]*c+t[y]*d;a[y]=a[p]-f,t[y]=t[p]-g,a[p]+=f,t[p]+=g}}}function z(a,t){let e=0;for(let i=0;i<t;i++)e=e<<1|a&1,a>>=1;return e}function K(a,t=44100,e={}){const{includeSpectrum:i=!1}=e;if(!a||a.length===0)return{rms:0,peak:0,peakToPeak:0,crestFactor:0,dcOffset:0,spectrum:{frequencies:new Float32Array(0),magnitudes:new Float32Array(0)}};const s={rms:E(a),peak:b(a),peakToPeak:_(a),crestFactor:O(a),dcOffset:R(a),spectrum:{frequencies:new Float32Array(0),magnitudes:new Float32Array(0)}};return i&&(s.spectrum=q(a,t)),s}class G{constructor(t,e=null){this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.isRunning=!1,this.sampleRate=44100,this.statsElement=e,this.statsFields=e?this._collectStatsFields(e):null,this.statsUpdateInterval=4,this.frameCounter=0,this.resize(),window.addEventListener("resize",()=>this.resize())}_collectStatsFields(t){const e=i=>t.querySelector(`[data-stat="${i}"]`);return{rms:e("rms"),peak:e("peak"),crest:e("crest"),dc:e("dc"),p2p:e("p2p")}}resize(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}start(t){this.isRunning=!0,this.dataFunction=t,this.draw()}stop(){this.isRunning=!1}draw(){if(!this.isRunning)return;const t=typeof this.dataFunction=="function"?this.dataFunction():null,e=this._normaliseTimeDomain(t),i=t&&t.frequencyDomain?t.frequencyDomain:null;t&&t.sampleRate&&(this.sampleRate=t.sampleRate),this._drawBackground(),this._drawWaveform(e),this._drawSpectrum(i),this._updateStats(e),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,requestAnimationFrame(()=>this.draw())}_normaliseTimeDomain(t){if(!t)return null;if(t.timeDomain instanceof Float32Array)return t.timeDomain;const e=Array.isArray(t)||t instanceof Uint8Array?t:null;if(!e)return null;const i=new Float32Array(e.length);for(let s=0;s<e.length;s++)i[s]=(e[s]-128)/128;return i}_drawBackground(){this.ctx.fillStyle="#111",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}_drawWaveform(t){if(!t||t.length===0)return;this.ctx.lineWidth=2,this.ctx.strokeStyle="#4a9eff",this.ctx.beginPath();const e=this.canvas.height,i=this.canvas.width,s=e*.65,n=(e-s)*.5,o=t.length/i;let h=0;for(let l=0;l<i;l++){const r=Math.floor(l*o),d=t[r]??0,c=n+(.5-d*.5)*s;l===0?this.ctx.moveTo(h,c):this.ctx.lineTo(h,c),h+=1}this.ctx.stroke()}_drawSpectrum(t){if(!t||t.length===0)return;const e=this.canvas.height,i=this.canvas.width,s=e*.25,n=e-s-6,o=40,h=Math.floor(t.length/o),l=i/o;this.ctx.fillStyle="rgba(74, 158, 255, 0.2)",this.ctx.fillRect(0,n,i,s+6);for(let r=0;r<o;r++){const d=r*h,y=(t[d]??0)/255*s,f=r*l,g=n+s-y,w=this.ctx.createLinearGradient(f,g,f,g+y);w.addColorStop(0,"#4a9eff"),w.addColorStop(1,"#1a3f70"),this.ctx.fillStyle=w,this.ctx.fillRect(f,g,l-1,Math.max(1,y))}}_updateStats(t){if(!this.statsFields||!t||t.length===0||this.frameCounter%this.statsUpdateInterval!==0)return;const e=K(t,this.sampleRate,{includeSpectrum:!1});this.statsFields.rms&&(this.statsFields.rms.textContent=e.rms.toFixed(3)),this.statsFields.peak&&(this.statsFields.peak.textContent=e.peak.toFixed(3)),this.statsFields.p2p&&(this.statsFields.p2p.textContent=e.peakToPeak.toFixed(3)),this.statsFields.crest&&(this.statsFields.crest.textContent=e.crestFactor.toFixed(2)),this.statsFields.dc&&(this.statsFields.dc.textContent=e.dcOffset.toFixed(3))}}const Y=50,H=15,W=0,V=10,Q=50,$=2,j=50,X=50,Z=50,J=95,tt=95,et=0,st=70,it=20,nt=0,at=30,ot=50,rt=50,ht=30,lt=["Pluck","Hit","Reed","Flute","Brass","Bow","Bell","Drum"];"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("sw.js").catch(a=>{console.warn("Service worker registration failed",a)})});let v=null;function ct(){const a=document.getElementById("install-button");a&&(window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),v=t,a.classList.add("visible")}),a.addEventListener("click",async()=>{if(v)try{a.disabled=!0,await v.prompt(),await v.userChoice}catch(t){console.warn("Install prompt failed",t)}finally{v=null,a.disabled=!1,a.classList.remove("visible")}}),window.addEventListener("appinstalled",()=>{v=null,a.classList.remove("visible"),a.disabled=!0}))}ct();class L{constructor(){this.processor=null,this.keyboard=null,this.visualizer=null,this.knobs={},this.switches={},this.isActive=!1,this.currentNote=null,this.initializeUI()}initializeUI(){const t=document.getElementById("power-button");t&&t.addEventListener("click",()=>this.togglePower()),this.knobs.dcLevel=new u(document.getElementById("dc-knob"),document.getElementById("dc-value"),s=>this.updateParameter("dcLevel",s),0,100,Y),this.knobs.noiseLevel=new u(document.getElementById("noise-knob"),document.getElementById("noise-value"),s=>this.updateParameter("noiseLevel",s),0,100,H),this.knobs.toneLevel=new u(document.getElementById("tone-knob"),document.getElementById("tone-value"),s=>this.updateParameter("toneLevel",s),0,100,W),this.knobs.attack=new u(document.getElementById("attack-knob"),document.getElementById("attack-value"),s=>this.updateParameter("attack",s),0,100,V),this.knobs.release=new u(document.getElementById("release-knob"),document.getElementById("release-value"),s=>this.updateParameter("release",s),0,100,Q),this.switches.interfaceType=new C(document.getElementById("interface-type-switch"),document.getElementById("interface-type-label"),lt,s=>this.updateParameter("interfaceType",s),$),this.knobs.interfaceIntensity=new u(document.getElementById("interface-intensity-knob"),document.getElementById("interface-intensity-value"),s=>this.updateParameter("interfaceIntensity",s),0,100,j),this.knobs.tuning=new u(document.getElementById("tuning-knob"),document.getElementById("tuning-value"),s=>this.updateParameter("tuning",s),0,100,X),this.knobs.ratio=new u(document.getElementById("ratio-knob"),document.getElementById("ratio-value"),s=>this.updateParameter("ratio",s),0,100,Z),this.knobs.delay1Feedback=new u(document.getElementById("delay1-fb-knob"),document.getElementById("delay1-fb-value"),s=>this.updateParameter("delay1Feedback",s),0,100,J),this.knobs.delay2Feedback=new u(document.getElementById("delay2-fb-knob"),document.getElementById("delay2-fb-value"),s=>this.updateParameter("delay2Feedback",s),0,100,tt),this.knobs.filterFeedback=new u(document.getElementById("filter-fb-knob"),document.getElementById("filter-fb-value"),s=>this.updateParameter("filterFeedback",s),0,100,et),this.knobs.filterFrequency=new u(document.getElementById("filter-freq-knob"),document.getElementById("filter-freq-value"),s=>this.updateParameter("filterFrequency",s),0,100,st),this.knobs.filterQ=new u(document.getElementById("filter-q-knob"),document.getElementById("filter-q-value"),s=>this.updateParameter("filterQ",s),0,100,it),this.knobs.filterShape=new u(document.getElementById("filter-shape-knob"),document.getElementById("filter-shape-value"),s=>this.updateParameter("filterShape",s),0,100,nt),this.knobs.lfoFrequency=new u(document.getElementById("lfo-freq-knob"),document.getElementById("lfo-freq-value"),s=>this.updateParameter("lfoFrequency",s),0,100,at),this.knobs.modulationTypeLevel=new u(document.getElementById("mod-type-level-knob"),document.getElementById("mod-type-level-value"),s=>this.updateParameter("modulationTypeLevel",s),0,100,ot,!0),this.knobs.reverbSize=new u(document.getElementById("reverb-size-knob"),document.getElementById("reverb-size-value"),s=>this.updateParameter("reverbSize",s),0,100,rt),this.knobs.reverbLevel=new u(document.getElementById("reverb-level-knob"),document.getElementById("reverb-level-value"),s=>this.updateParameter("reverbLevel",s),0,100,ht);const e=document.getElementById("keyboard");e&&(this.keyboard=new N(e,(s,n)=>this.handleNoteOn(s,n),s=>this.handleNoteOff(s)));const i=document.getElementById("visualizer");if(i){const s=document.getElementById("visualizer-stats");this.visualizer=new G(i,s)}this.updateStatus()}async togglePower(){this.isActive?this.powerOff():await this.powerOn()}async powerOn(){try{this.processor=new x,await this.processor.initialize(),Object.entries(this.knobs).forEach(([e,i])=>{const s=this.getParameterName(e);this.processor.setParameter(s,i.value/100)}),this.switches.interfaceType&&this.processor.setParameter("interfaceType",this.switches.interfaceType.currentPosition),this.visualizer&&this.visualizer.start(()=>this.processor.getAnalyserData()),this.isActive=!0;const t=document.getElementById("power-button");t&&t.classList.add("active"),this.updateStatus(),console.log("Stove powered on")}catch(t){console.error("Failed to initialize audio:",t),alert("Failed to initialize audio. Please check browser compatibility.")}}powerOff(){this.processor&&(this.keyboard&&this.keyboard.releaseAllKeys(),this.processor.shutdown(),this.processor=null),this.visualizer&&this.visualizer.stop(),this.isActive=!1,this.currentNote=null;const t=document.getElementById("power-button");t&&t.classList.remove("active"),this.updateStatus(),console.log("Stove powered off")}handleNoteOn(t,e){this.isActive&&(this.currentNote=t,this.processor.noteOn(e),this.updateStatus())}handleNoteOff(t){this.isActive&&this.currentNote===t&&(this.processor.noteOff(),this.currentNote=null,this.updateStatus())}updateParameter(t,e){this.processor&&this.processor.isActive&&this.processor.setParameter(t,e)}getParameterName(t){return{dcLevel:"dcLevel",noiseLevel:"noiseLevel",toneLevel:"toneLevel",attack:"attack",release:"release",interfaceIntensity:"interfaceIntensity",tuning:"tuning",ratio:"ratio",delay1Feedback:"delay1Feedback",delay2Feedback:"delay2Feedback",filterFeedback:"filterFeedback",filterFrequency:"filterFrequency",filterQ:"filterQ",filterShape:"filterShape",lfoFrequency:"lfoFrequency",modulationTypeLevel:"modulationTypeLevel",reverbSize:"reverbSize",reverbLevel:"reverbLevel"}[t]||t}updateStatus(){}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.synthApp=new L}):window.synthApp=new L;window.addEventListener("beforeunload",()=>{window.synthApp&&window.synthApp.isActive&&window.synthApp.powerOff()});
